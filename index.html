<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>烏布香氛慢活行程</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
   
    <style>
        :root {
            --bg-color: #f2e8d5;
            --card-color: #fdfaf3;
            --accent-color: #d44601; /* 溫暖橙 */
            --text-on-dark: #5c0d09; /* 深紅 */
            --text-on-light: #177263; /* 柔藍 */
            --menu-bg: #a0d0b0;
            --weather-gradient: linear-gradient(135deg, #a0d0b0 0%, #177263 100%);
            --highlight-gold: #c5a35f;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: "Montserrat", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-on-dark);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            overscroll-behavior-y: none; /* iOS 優化：防止拉動刷新 */
        }
        /* --- Header --- */
        header {
            padding: 15px 20px;
            background-color: rgba(242, 232, 213, 0.98);
            border-bottom: 1px solid rgba(82, 192, 167, 0.2);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px;
        }
        header h1 { margin: 0; font-size: 1.2rem; font-family: "Playfair Display", serif;
            letter-spacing: 1px; color: var(--highlight-gold);
        }
       
        .header-icons { display: flex; gap: 20px; align-items: center; }
        .header-btn { color: var(--text-on-dark); font-size: 1.2rem; cursor: pointer; text-decoration: none; position: relative;}
        .fan-btn i { color: var(--accent-color); }
        /* --- Global Date Selector --- */
        .date-selector-container {
            background: var(--bg-color); z-index: 90;
            padding: 10px 20px 10px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .date-selector {
            display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .date-selector::-webkit-scrollbar { display: none; }
       
        .date-chip {
            background: rgba(82, 192, 167, 0.2);
            padding: 8px 12px; border-radius: 20px;
            white-space: nowrap; font-size: 0.85rem; cursor: pointer; color: var(--text-on-dark);
            display: flex; flex-direction: column; align-items: center; min-width: 55px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .date-chip.active {
            background: var(--accent-color); color: #fff;
            box-shadow: 0 0 10px rgba(212, 70, 1, 0.3); transform: scale(1.05);
        }
        /* --- Main Content --- */
        main { flex: 1; overflow-y: hidden; position: relative; }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 10px 0 90px 0;
            display: none; opacity: 0; transition: opacity 0.3s ease;
            background-color: var(--bg-color);
            -webkit-overflow-scrolling: touch;
        }
        .page.active { display: block; opacity: 1; z-index: 10; }
       
        /* Map Page Specific */
        #page-map { padding: 0 0 80px 0; }
        #map-container { width: 100%; height: 100%; }
        /* 子頁面 */
        .sub-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .sub-page.open { transform: translateX(0); }
        .sub-header {
            padding: 15px 20px; background: var(--menu-bg);
            border-bottom: 1px solid rgba(23, 114, 99, 0.2);
            display: flex; align-items: center; gap: 15px;
        }
        .back-btn { font-size: 1.2rem; color: var(--accent-color); background: none; border: none; padding: 5px; cursor: pointer;}
        .sub-header h2 { margin: 0; font-size: 1.1rem; font-family: "Playfair Display", serif;
            color: var(--highlight-gold);
        }
        .sub-content {
            flex: 1; overflow-y: auto; padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        /* --- Timeline & Cards --- */
        .timeline-container { padding: 0 20px; }
        .timeline-item {
            position: relative; padding-left: 25px; padding-bottom: 30px;
            border-left: 2px solid rgba(212, 70, 1, 0.3);
        }
        .timeline-item:last-child { border-left: 2px solid transparent; padding-bottom: 0; }
        .timeline-item::before {
            content: ''; position: absolute; left: -6px; top: 18px;
            width: 10px; height: 10px; background: var(--accent-color);
            border-radius: 50%; box-shadow: 0 0 0 4px rgba(242, 232, 213, 0.5);
        }
        .card {
            background-color: var(--card-color); color: var(--text-on-dark);
            border-radius: 16px;
            padding: 16px; margin-bottom: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
        }
        .card:active { transform: scale(0.98); }
        .card-time { font-size: 0.85rem; color: var(--accent-color); font-weight: 700; display: block; margin-bottom: 6px; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 8px 0; font-family: "Playfair Display", serif;
            line-height: 1.4; padding-right: 10px; color: var(--highlight-gold);
        }
        .card-price {
            position: absolute; bottom: 12px; right: 15px;
            font-weight: bold; color: var(--text-on-light); font-size: 0.9rem;
            background: rgba(82, 192, 167, 0.3);
            padding: 2px 6px; border-radius: 4px;
        }
        .tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 5px; max-width: 70%; }
        .card-tag { font-size: 0.7rem; background: rgba(242, 232, 213, 0.5);
            padding: 3px 8px; border-radius: 4px; color: var(--text-on-dark); }
        .card-tag.highlight { background: rgba(212, 70, 1, 0.4); color: #fff; border: 1px solid var(--accent-color); }
        .card-tag.tips { background: rgba(23, 114, 99, 0.4); color: #fff; }
        .card-tag.alert { background: rgba(92, 13, 9, 0.4); color: #fff; border: 1px solid var(--text-on-dark); font-weight: bold;}
        /* --- Weather Styles --- */
        .weather-card {
            background: var(--weather-gradient);
            border-radius: 16px; padding: 25px; margin: 20px;
            text-align: center; color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .weather-main { display: flex; justify-content: space-around; align-items: center; margin: 20px 0; }
        .weather-icon { font-size: 3.5rem; }
        .weather-temp { font-size: 3rem; font-weight: 300; }
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; }
        .w-item { font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        /* --- Shopping Styles --- */
        .shopping-section-title { font-family: "Playfair Display", serif;
            margin: 0 0 10px 0; color: var(--accent-color); border-bottom: 1px solid rgba(82, 192, 167, 0.3);
            padding-bottom: 5px;}
        .shopping-group { margin-bottom: 25px; background: rgba(82, 192, 167, 0.05);
            padding: 15px; border-radius: 12px; }
        /* --- Tools Grid --- */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px; }
        .tool-btn {
            background: rgba(82, 192, 167, 0.1);
            padding: 25px 15px;
            border-radius: 16px; text-align: center;
            border: 1px solid rgba(23, 114, 99, 0.1); cursor: pointer;
        }
        .tool-btn i { font-size: 2.2rem; color: var(--accent-color); margin-bottom: 12px; display: block; }
        /* --- Lists --- */
        .checklist-item {
            background: rgba(82, 192, 167, 0.08); padding: 15px; margin-bottom: 12px;
            border-radius: 8px; display: flex; align-items: center; gap: 15px; cursor: pointer;
        }
        .checklist-item.checked { opacity: 0.5; }
        .checklist-item.checked span { text-decoration: line-through; }
        .checklist-item input { width: 22px; height: 22px; accent-color: var(--accent-color); pointer-events: none; }
       
        /* --- Footer --- */
        nav.bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            background-color: var(--menu-bg);
            display: flex; justify-content: space-around;
            padding: 10px 0 25px 0; border-top: 1px solid rgba(23, 114, 99, 0.2);
            z-index: 100;
        }
        .nav-item { color: var(--text-on-light); text-align: center; font-size: 0.75rem; cursor: pointer; width: 25%; }
        .nav-item i { display: block; font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--highlight-gold); }
        /* --- Modal --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000;
            justify-content: center; align-items: end; backdrop-filter: blur(3px);
        }
        .modal.open { display: flex; }
        .modal-content {
            background: var(--card-color); color: var(--text-on-dark);
            width: 100%; max-width: 600px; max-height: 85vh;
            border-radius: 20px 20px 0 0; padding: 25px;
            overflow-y: auto; animation: slideUp 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.8rem; color: var(--text-on-light); cursor: pointer; }
       
        .info-row { margin: 12px 0; display: flex; align-items: flex-start; gap: 12px; font-size: 0.95rem; line-height: 1.6; }
        .info-row i { color: var(--accent-color); margin-top: 4px; width: 20px; text-align: center; }
        .note-box {
            background: rgba(242, 232, 213, 0.5);
            border-left: 4px solid var(--accent-color);
            padding: 15px; margin: 20px 0; border-radius: 0 8px 8px 0;
            font-size: 0.95rem; color: var(--text-on-dark); line-height: 1.7;
        }
        .link-btn {
            display: inline-block; background: rgba(82, 192, 167, 0.3);
            color: var(--text-on-dark);
            padding: 6px 12px; border-radius: 4px; text-decoration: none;
            font-size: 0.85rem; margin-top: 5px; border: 1px solid var(--menu-bg);
        }
        .action-btn {
            display: flex; justify-content: center; align-items: center; gap: 8px;
            width: 100%; padding: 14px; margin-top: 20px;
            background: var(--accent-color); color: white;
            text-decoration: none; border-radius: 10px;
            font-weight: bold; font-size: 1rem; border: none; cursor: pointer;
        }
       
        /* Taxi Card */
        .taxi-card {
            background: var(--card-color); color: var(--text-on-dark); padding: 20px;
            border: 4px solid var(--highlight-gold);
            margin: 15px 0;
            text-align: center; border-radius: 8px;
        }
        /* Edit Form Styles */
        .edit-form { display: none; padding: 20px; background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2500; justify-content: center; align-items: center; }
        .edit-form.open { display: flex; }
        .edit-content { background: var(--card-color); color: var(--text-on-dark); padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
        .edit-content input, .edit-content textarea { width: 100%; margin: 10px 0; padding: 8px; background: rgba(242, 232, 213, 0.3); border: 1px solid var(--menu-bg); color: var(--text-on-dark); }
        .edit-content button { background: var(--accent-color); color: white; border: none; padding: 10px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>
    <header>
        <h1>烏布香氛慢活行程</h1>
        <div class="header-icons">
            <a href="googletranslate://" class="header-btn" title="Google Translate">
                <i class="fa-solid fa-language"></i>
            </a>
            <a href="#" class="header-btn fan-btn" onclick="openToolsPage(); return false;">
                <i class="fa-solid fa-fan fa-spin" style="animation-duration: 10s;"></i>
            </a>
            <a href="#" class="header-btn" onclick="openEditForm(); return false;" title="Add Event">
                <i class="fa-solid fa-plus"></i>
            </a>
        </div>
    </header>
    <div class="date-selector-container">
        <div class="date-selector" id="date-selector"></div>
    </div>
    <main>
        <div id="page-itinerary" class="page active">
            <div class="timeline-container" id="timeline-container" style="padding-top: 20px;"></div>
            <div style="text-align:center; color:var(--text-on-light); font-size:0.8rem; margin:30px 0;">平安喜樂 • 滿載而歸</div>
        </div>
        <div id="page-map" class="page">
            <div id="map-container"></div>
            <div style="position:absolute; bottom:90px; left:10px; background:rgba(242,232,213,0.9); padding:8px 12px; border-radius:8px; color:var(--text-on-dark); font-size:0.8rem; box-shadow:0 2px 5px rgba(0,0,0,0.1); pointer-events:none; z-index:999;">
                <i class="fa-solid fa-location-dot" style="color:var(--accent-color)"></i> 顯示當日行程地點
            </div>
        </div>
        <div id="page-weather" class="page">
            <div style="padding: 20px;">
                <h2 style="font-family:'Playfair Display',serif; text-align:center; margin-bottom:10px;">當日天氣預報</h2>
                <div id="weather-content"></div>
               
                <div style="background:rgba(82,192,167,0.1); padding:15px; border-radius:12px; margin:20px 0; display:flex; align-items:center; justify-content:space-between; border:1px solid rgba(23,114,99,0.1);">
                    <div>
                        <div style="font-weight:bold; color:var(--accent-color);"><i class="fa-solid fa-glass-water"></i> 水分補給 Check</div>
                        <div style="font-size:0.8rem; opacity:0.7; margin-top:4px;">喝酒前請先喝水</div>
                    </div>
                    <div style="display:flex; gap:15px; align-items:center;">
                        <button onclick="addWater()" style="background:var(--accent-color); border:none; color:white; width:45px; height:45px; border-radius:50%; font-size:1.2rem; cursor:pointer;"><i class="fa-solid fa-plus"></i></button>
                        <span id="water-count" style="font-size:2rem; font-family:'Playfair Display',serif; min-width:30px; text-align:center;">0</span>
                    </div>
                </div>
                <div class="note-box">
                    <div style="font-weight:bold; margin-bottom:5px; color:var(--accent-color);">9月峇里氣候 TIPS：</div>
                    乾季溫暖乾燥（平均25-30°C）。<br>
                    偶有陣雨，請務必隨身攜帶輕便雨傘。<br>
                    防曬與補水是每日最重要的事。
                </div>
            </div>
        </div>
        <div id="page-shopping" class="page">
            <div style="padding: 20px;">
                <h2 style="font-family:'Playfair Display',serif; text-align:center;">今日購物建議</h2>
                <p style="text-align:center; opacity:0.7; font-size:0.85rem; margin-bottom:20px;">根據當日行程地點推薦</p>
               
                <div id="daily-shopping-list"></div>
                <div style="margin-top:40px; border-top:1px solid rgba(23,114,99,0.1); padding-top:20px;">
                    <h3 style="color:var(--text-on-light); font-size:1rem;">全行程購物清單 (General)</h3>
                    <div id="general-shopping-container"></div>
                </div>
            </div>
        </div>
        <div id="page-tools" class="page">
            <h2 style="text-align:center; margin: 30px 0 20px 0; font-family:'Playfair Display',serif;">旅人百寶箱</h2>
            <div class="tools-grid">
                <div class="tool-btn" onclick="openSubPage('hotel')">
                    <i class="fa-solid fa-bed"></i><span>酒店資訊</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('packing')">
                    <i class="fa-solid fa-suitcase"></i><span>行李清單</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('charter')">
                    <i class="fa-solid fa-car"></i><span>包車資訊</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('rate')">
                    <i class="fa-solid fa-yen-sign"></i><span>匯率換算</span>
                </div>
                <div class="tool-btn" onclick="openSubPage('safety')">
                    <i class="fa-solid fa-user-shield"></i><span>安全報平安</span>
                </div>
                <div class="tool-btn" onclick="openTipsModal()">
                    <i class="fa-regular fa-compass"></i><span>路痴救星</span>
                </div>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button onclick="history.back()" style="background:none; border:1px solid var(--text-on-light); color:var(--text-on-dark); padding:10px 20px; border-radius:20px;">關閉百寶箱</button>
            </div>
        </div>
        <div id="subpage-hotel" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('hotel')"><i class="fa-solid fa-arrow-left"></i></button><h2>酒店資訊</h2></div>
            <div class="sub-content">
                <h3 style="color:var(--accent-color); font-family:'Playfair Display',serif; margin-bottom:10px;">Tegal Sari Accommodation (Super Deluxe Wooden Room, Upper Floor)</h3>
                <div style="font-size:0.9rem; opacity:0.8; margin-bottom:20px;">這家飯店以稻田景觀和安靜氛圍聞名，房間內配有蚊帳、空調和私人陽台；建議入住後檢查Wi-Fi連線，並下載離線地圖App（如Google Maps）以輔助步行導航；飯店提供免費早餐，可選擇稻田邊的露天座位享用。</div>
               
                <div class="note-box">
                    <i class="fa-solid fa-location-dot" style="color:var(--accent-color)"></i> <b>地址：</b><br>
                    Jl. Hanoman, Padang Tegal, Ubud<br>
                    <span style="font-size:0.8rem; color:#666;">(Jl. Hanoman, Padang Tegal, Ubud)</span><br>
                    <a href="https://www.google.com/maps/search/?api=1&query=Tegal+Sari+Accommodation+Ubud" target="_blank" class="link-btn" style="margin-top:8px;">開啟地圖</a>
                </div>
                <div class="checklist-item" style="opacity:1; cursor:default;">
                    <i class="fa-regular fa-clock" style="color:var(--accent-color)"></i>
                    <span><b>Check-in:</b> 14:00 起 / <b>Out:</b> 11:30 前</span>
                </div>
                <h4 style="border-bottom:1px solid var(--menu-bg); padding-bottom:5px; margin-top:25px;">特色</h4>
                <ul style="padding-left:20px; line-height:1.6; font-size:0.95rem;">
                    <li>稻田景觀和安靜氛圍</li>
                    <li>房間內配有蚊帳、空調和私人陽台</li>
                    <li>免費早餐，可選擇稻田邊的露天座位享用</li>
                    <li>建議入住後檢查Wi-Fi連線，並下載離線地圖App</li>
                </ul>
            </div>
        </div>
        <div id="subpage-packing" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('packing')"><i class="fa-solid fa-arrow-left"></i></button><h2>行李清單</h2></div>
            <div class="sub-content" id="packing-list-container"></div>
        </div>
        <div id="subpage-charter" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('charter')"><i class="fa-solid fa-arrow-left"></i></button><h2>包車資訊</h2></div>
            <div class="sub-content">
                <div style="background: rgba(82,192,167,0.05); border-radius: 12px; padding: 25px; margin-top: 20px; text-align:center;">
                    <i class="fa-solid fa-car-side" style="font-size:3rem; color:var(--accent-color); margin-bottom:15px; opacity:0.8;"></i>
                    <h3 style="margin:0 0 10px 0; color:var(--text-on-dark);">私人包車資料</h3>
                    <p style="font-size:0.9rem; opacity:0.7; margin-bottom:25px;">暫無資料，待確認後填入</p>
                    
                    <div style="text-align:left; background:rgba(242,232,213,0.3); padding:15px; border-radius:8px; margin-bottom:10px;">
                        <div style="font-size:0.8rem; color:var(--text-on-light);">司機姓名 (Driver Name)</div>
                        <div style="font-size:1.1rem; border-bottom:1px dashed #ccc; padding:5px 0; color:#ccc;">(待填寫)</div>
                    </div>
                    <div style="text-align:left; background:rgba(242,232,213,0.3); padding:15px; border-radius:8px; margin-bottom:10px;">
                        <div style="font-size:0.8rem; color:var(--text-on-light);">車牌號碼 (Plate No.)</div>
                        <div style="font-size:1.1rem; border-bottom:1px dashed #ccc; padding:5px 0; color:#ccc;">(待填寫)</div>
                    </div>
                     <div style="text-align:left; background:rgba(242,232,213,0.3); padding:15px; border-radius:8px;">
                        <div style="font-size:0.8rem; color:var(--text-on-light);">聯絡電話 (WhatsApp)</div>
                        <div style="font-size:1.1rem; border-bottom:1px dashed #ccc; padding:5px 0; color:#ccc;">(待填寫)</div>
                    </div>
                </div>
            </div>
        </div>
       
        <div id="subpage-rate" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('rate')"><i class="fa-solid fa-arrow-left"></i></button><h2>匯率換算</h2></div>
            <div class="sub-content" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:80%;">
                <div style="background: rgba(82,192,167,0.05); padding: 20px; border-radius: 12px; width:100%;">
                    <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                         <label style="font-size:0.8rem; color:var(--text-on-light);">匯率: <input type="number" id="rate-setting" value="0.052" step="0.001" style="width:60px; background:transparent; color:var(--text-on-dark); border:1px solid var(--menu-bg); text-align:center; border-radius:4px;"></label>
                    </div>
                    <label>印尼盾 (IDR)</label><input type="number" id="jpy-input" placeholder="Rp" oninput="calcRate('jpy')" style="width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; background: rgba(242,232,213,0.3); border: 1px solid var(--menu-bg); color: var(--text-on-dark); border-radius: 8px; text-align: center;">
                    <div style="text-align:center; font-size:1.5rem; margin:10px 0; color:var(--accent-color);">⇅</div>
                    <label>港幣 (HKD)</label><input type="number" id="hkd-input" placeholder="$" oninput="calcRate('hkd')" style="width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; background: rgba(242,232,213,0.3); border: 1px solid var(--menu-bg); color: var(--text-on-dark); border-radius: 8px; text-align: center;">
                </div>
            </div>
        </div>
       
        <div id="subpage-safety" class="sub-page">
            <div class="sub-header"><button class="back-btn" onclick="closeSubPage('safety')"><i class="fa-solid fa-arrow-left"></i></button><h2>安全功能</h2></div>
            <div class="sub-content">
                <div id="safety-btn" style="text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #177263, #a0d0b0); border-radius: 16px; margin-bottom: 20px; cursor: pointer;" onclick="sendSafetyMessage()">
                    <i class="fa-brands fa-whatsapp" style="font-size:3rem; color:white; margin-bottom:15px;"></i>
                    <h3 style="margin:0 0 10px 0;">一鍵報平安 (WhatsApp)</h3>
                    <p style="opacity:0.8; margin:0;">按此發送位置給家人</p>
                </div>
                <h3 style="border-bottom:1px solid var(--menu-bg); padding-bottom:10px; margin-top:30px;">緊急資訊</h3>
                <div class="checklist-item" onclick="alert('110')"><i class="fa-solid fa-shield-halved" style="color:var(--accent-color);"></i><span>警察局: 110</span></div>
                <div class="checklist-item" onclick="alert('119')"><i class="fa-solid fa-truck-medical" style="color:var(--accent-color);"></i><span>救護/消防: 119</span></div>
            </div>
        </div>
    </main>
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchMainPage('itinerary', this)"><i class="fa-solid fa-calendar-days"></i> 行程</div>
        <div class="nav-item" onclick="switchMainPage('map', this)"><i class="fa-solid fa-map-location-dot"></i> 地圖</div>
        <div class="nav-item" onclick="switchMainPage('weather', this)"><i class="fa-solid fa-cloud-sun-rain"></i> 天氣</div>
        <div class="nav-item" onclick="switchMainPage('shopping', this)"><i class="fa-solid fa-basket-shopping"></i> 購物</div>
    </nav>
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">×</span>
            <div class="modal-header"><h2 id="modal-title">標題</h2><span id="modal-type" class="sub">類型</span></div>
            <div class="modal-body">
               
                <div id="taxi-card" class="taxi-card" style="display:none;">
                    <p style="font-size:0.8rem; color:var(--text-on-light); margin:0 0 5px 0;">Indonesian (Bahasa)</p>
                    <h2 style="font-size:1.4rem; margin:5px 0; font-weight:bold; line-height:1.2; color:var(--accent-color)">Pak Sopir, tolong antar saya ke sini</h2>
                    <h3 id="taxi-address" style="font-size:1.1rem; margin:10px 0; line-height:1.4; border-top:1px dashed #ccc; padding-top:10px;"></h3>
                    <p id="taxi-name" style="font-size:1rem; margin-top:5px; color:var(--text-on-dark); font-weight:bold;"></p>
                </div>

                <div class="info-row"><i class="fa-regular fa-clock"></i><span id="modal-time">時間</span></div>
                <div class="info-row"><i class="fa-solid fa-location-dot"></i><span id="modal-address">地址</span></div>
                <div class="info-row" id="modal-price-row"><i class="fa-solid fa-money-bill-wave"></i><span id="modal-price"></span></div>
               
                <div class="note-box">
                    <div style="font-weight:bold; margin-bottom:8px; color:var(--accent-color);">攻略與 TIPS：</div>
                    <span id="modal-note">內容...</span>
                </div>
                <div id="modal-links" style="margin-bottom: 20px;"></div>
               
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
                     <button class="action-btn" id="modal-map-btn" style="margin-top:0;"><i class="fa-solid fa-map-location-dot"></i> Google 導航</button>
                     <button class="action-btn" onclick="toggleTaxiCard()" style="margin-top:0; background:var(--text-on-light);"><i class="fa-solid fa-taxi"></i> 給司機看</button>
                </div>
            </div>
        </div>
    </div>
    <div id="edit-form" class="edit-form" onclick="if(event.target===this)closeEditForm()">
        <div class="edit-content">
            <h3>添加新行程事件</h3>
            <input type="text" id="edit-time" placeholder="時間 (e.g. 14:00 - 16:00)">
            <input type="text" id="edit-title" placeholder="標題">
            <input type="text" id="edit-type" placeholder="類型 (e.g. 美食)">
            <input type="text" id="edit-price" placeholder="價格 (e.g. ¥2,000)">
            <input type="text" id="edit-address" placeholder="地址">
            <input type="text" id="edit-coords" placeholder="座標 (e.g. -8.519,115.263) - 可選">
            <textarea id="edit-note" placeholder="筆記 (HTML支援)"></textarea>
            <input type="text" id="edit-tags" placeholder="標籤 (逗號分隔, e.g. 美食,必去)">
            <input type="text" id="edit-shopping" placeholder="購物項目 (逗號分隔)">
            <input type="text" id="edit-link" placeholder="連結 (可選)">
            <button onclick="saveNewEvent()">儲存</button>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- DATA ---
        let scheduleData = {
            "day1": {
                "date": "9/25 (五)",
                "events": [
                    { time: "15:00", title: "抵達峇里島伍拉·賴國際機場 (DPS)", type: "交通", price: "", address: "峇里島伍拉·賴國際機場 (DPS)", coords: [-8.74817, 115.167], note: "<b>備註：</b>辦理入境手續後，在接機大廳尋找舉著 \"Tegal Sari\" 牌子的司機。若延誤，可提前透過飯店WhatsApp聯繫確認；機場內有免費Wi-Fi，可用來更新家人行程。<br><b>交通方式：</b> Tegal Sari 酒店專車 (Hotel Transfer)。酒店專車為舒適的空調車輛，司機通常穿制服並持有識別證；預估從機場到飯店的車程約1.5-2小時，視交通狀況而定，途中可欣賞峇里島郊區景觀。", tags: ["移動"], shopping_items: [] },
                    { time: "17:30", title: "抵達飯店 Tegal Sari Accommodation 辦理入住", type: "住宿", price: "USD 40-50/晚", address: "Jl. Hanoman, Padang Tegal, Ubud", coords: [-8.5196, 115.26324], note: "<b>重點：</b>確認房間為「二樓 (Upper Floor)」且面向稻田。若房間不符，可禮貌要求更換；入住後，檢查房間安全設施如門鎖和保險箱，並設定個人密碼。<br><b>開放時間：</b>Check-in 從 14:00 開始，Check-out 至 11:30；飯店大廳與服務 24 小時開放", tags: ["入住", "安全"], shopping_items: [] },
                    { time: "18:00", title: "前往 Coco Supermarket 採買", type: "購物", price: "IDR 100,000-300,000", address: "Jl. Raya Pengosekan (飯店出門右轉即達)", coords: [-8.51798, 115.26357], note: "<b>任務：</b>購買這幾天需要的紅酒、起司、水果、優格、飲用水。超市內有新鮮蔬果區和進口商品櫃，建議多買防蚊噴霧和防曬霜；採買時間預留30分鐘，注意貨架標價以避免結帳時混亂。<br><b>開放時間：</b>每天 7:00 AM 至 11:00 PM（有些分店接近 24 小時）", tags: ["步行", "購物"], shopping_items: ["紅酒", "起司", "水果", "優格", "飲用水", "防蚊噴霧", "防曬霜"] },
                    { time: "19:00", title: "晚餐：Pison Ubud", type: "餐飲", price: "HKD 50-100", address: "Jl. Hanoman No. 10X", coords: [-8.51783, 115.26371], note: "<b>特色：</b>稻田景觀咖啡廳，食物精緻，週五晚氣氛佳且安全。餐廳提供露天座位，可邊用餐邊聽輕音樂；推薦菜餚如新鮮沙拉或義大利麵，搭配一杯紅酒；環境適合拍照，記得攜帶手機充電器以防電量不足。<br><b>開放時間：</b>每天 7:00 AM 至 11:00 PM", tags: ["步行", "晚餐", "單身女性友善"], shopping_items: [] },
                    { time: "20:30", title: "步行回飯店，在陽台享受第一晚的寧靜", type: "休息", price: "", address: "Tegal Sari Accommodation", coords: [-8.5196, 115.26324], note: "陽台面向稻田，可聽見蟲鳴和風聲；建議泡一杯熱茶，記錄當日心得，或輕做伸展以緩解飛行疲勞。", tags: ["休息"], shopping_items: [] }
                ]
            },
            "day2": {
                "date": "9/26 (六)",
                "events": [
                    { time: "09:30", title: "包車司機於飯店大廳接送", type: "交通", price: "", address: "Tegal Sari Accommodation", coords: [-8.5196, 115.26324], note: "出發前，確認司機證件並告知大致路線；攜帶輕便背包裝水和零食。<br><b>交通方式：</b> 私人包車 (Private Car Charter) - 約 10 小時。包車車型建議選擇中型SUV以確保舒適，司機可兼導遊提供景點解說；全程預估行駛距離約80-100公里，包含北上和南下路線，途中可要求短暫停車拍照或休息。", tags: ["包車", "安全"], shopping_items: [] },
                    { time: "09:45", title: "前往 BMC Money Changer (Jalan Hanoman 分店)", type: "兌換", price: "", address: "Jl. Raya Pengosekan Ubud No.108, Ubud", coords: [-8.51798, 115.26357], note: "<b>任務：</b>使用港幣兌換印尼盾 (IDR)。兌換時檢查匯率並索取收據；預估只需15分鐘，附近有小攤可買咖啡提神。<br><b>開放時間：</b>通常每天 8:00 AM 至 9:00 PM（視分店而定）", tags: ["兌換"], shopping_items: [] },
                    { time: "10:30", title: "前往 Gunung Kawi Sebatu 神廟", type: "活動", price: "IDR 50,000-100,000", address: "Sebatu, Tegallalang", coords: [-8.3844168, 115.293], note: "<b>活動：</b>Melukat 水淨化儀式 (需換上沙龍，感受泉水祈福)。儀式持續約45-60分鐘，需脫鞋並尊重當地習俗；神廟環境清涼，建議穿輕便衣物並帶毛巾擦拭；此處為精神淨化點，可在泉水邊冥想5-10分鐘。<br><b>開放時間：</b>每天 8:00 AM 至 6:00 PM", tags: ["淨化", "必去"], shopping_items: [] },
                    { time: "12:00", title: "午餐：請司機推薦附近的景觀餐廳", type: "餐飲", price: "", address: "Kintamani 區或德哥拉朗區", coords: [], note: "午餐時間預留1小時，選擇有稻田或山景的餐廳；推薦菜餚如Nasi Goreng或新鮮海鮮，搭配椰子水；用餐後可短暫散步消化。<br>所有餐廳選擇均考慮單身女性友善環境，如明亮照明、女性服務員比例高，並建議提前查看菜單以避開過敏食材；用餐時間分配為至少1小時，包含點餐、享用和休息，以確保不匆忙。", tags: ["午餐", "景觀", "單身女性友善"], shopping_items: [] },
                    { time: "13:30", title: "前往 Svasensa Perfume Workshop", type: "活動", price: "IDR 459,000", address: "Toya Ubud Eco Park, Jl. Raya Desa Kenderan", coords: [-8.439, 115.281], note: "<b>活動：</b>Signature Workshop (初階調香，90分鐘)。工作坊提供專業指導，學習香氛基礎知識；過程中可試聞多種精油，製作個人香水樣本；環境綠意盎然，適合拍照留念。<br><b>開放時間：</b>需預約，通常每天 9:00 AM 至 6:00 PM", tags: ["調香", "必去"], shopping_items: [] },
                    { time: "16:00", title: "前往 Setia Darma House of Mask and Puppets (面具博物館)", type: "活動", price: "IDR 50,000-100,000", address: "Jalan Tegal Bingin, Mas, Ubud", coords: [-8.53426, 115.27923], note: "<b>活動：</b>欣賞數千件傳統面具與木偶，環境清幽。博物館占地廣闊，預留1小時慢慢瀏覽；有導覽牌解說歷史，可購買小紀念品；注意室內光線較暗，攜帶手機手電筒輔助。<br><b>開放時間：</b>每天 8:00 AM 至 4:00 PM", tags: ["博物館"], shopping_items: ["小紀念品"] },
                    { time: "17:30", title: "司機載回 Tegal Sari 放下戰利品", type: "交通", price: "", address: "Tegal Sari Accommodation", coords: [-8.5196, 115.26324], note: "回程約30分鐘，可在車上小憩；放下物品後，檢查是否遺漏東西。", tags: ["包車"], shopping_items: [] },
                    { time: "18:30", title: "晚餐：The Yoga Barn (Garden Kafe)", type: "餐飲", price: "IDR 50,000-100,000", address: "Jl. Hanoman (飯店斜對面巷內)", coords: [-8.5193, 115.2653], note: "<b>特色：</b>烏布著名的瑜伽中心，提供有機健康料理，環境放鬆。餐廳有瑜伽氛圍，可選擇戶外座位聽音樂；推薦菜餚如蔬食沙拉或smoothie bowl，適合恢復體力；用餐後可短暫參觀瑜伽工作室。<br><b>開放時間：</b>每天 7:30 AM 至 9:00 PM", tags: ["步行", "晚餐", "健康"], shopping_items: [] }
                ]
            },
            "day3": {
                "date": "9/27 (日)",
                "events": [
                    { time: "09:30", title: "前往 ARMA Museum (Agung Rai Museum of Art)", type: "活動", price: "IDR 150,000", address: "Jl. Raya Pengosekan", coords: [-8.52292, 115.26327], note: "<b>活動：</b>在皇家花園般的博物館內散步，欣賞峇里島傳統繪畫。博物館有陰涼步道，預留2小時瀏覽展品和花園；有咖啡館可買飲料休息；注意藝術品不可觸碰，攜帶筆記本記錄靈感。<br><b>開放時間：</b>每天 9:00 AM 至 6:00 PM", tags: ["步行", "藝術"], shopping_items: [] },
                    { time: "11:30", title: "前往 Jalan Raya Andong (古董街) 上游", type: "購物", price: "IDR 100,000-500,000", address: "Jalan Raya Andong, Ubud", coords: [-8.5077, 115.27108], note: "<b>策略：</b>搭車到 Andong 區，然後慢慢往下坡走，沿路逛木雕店。車程約15-20分鐘；逛街時預留2小時，注意坡度緩慢下行；店家多為家庭式，可議價購買小古物如木雕或銀器。<br><b>開放時間：</b>店舖通常每天 8:00 AM 至 6:00 PM<br><b>交通方式：</b> 短程 Grab + 步行。Grab叫車時，使用飯店Wi-Fi並分享位置給家人；選擇評價4.8以上的司機，預估車費低廉；步行部分選擇日光充足時段，避免中午高溫。", tags: ["Grab", "購物"], shopping_items: ["木雕", "銀器"] },
                    { time: "13:30", title: "從古董街搭車回飯店附近", type: "交通", price: "", address: "Tegal Sari Accommodation", coords: [-8.5196, 115.26324], note: "回程約10分鐘，可在車上喝水補充水分。", tags: ["Grab"], shopping_items: [] },
                    { time: "14:00", title: "午餐：Bebek Bengil (髒鴨飯總店)", type: "餐飲", price: "RM 63", address: "Jl. Hanoman (飯店正隔壁)", coords: [-8.51783, 115.26371], note: "<b>特色：</b>創始老店，稻田景觀，可在涼亭內用餐。推薦招牌鴨飯，搭配峇里島啤酒；涼亭有風扇，環境涼爽；用餐後可觀賞稻田鳥類。<br><b>開放時間：</b>通常每天 11:00 AM 至 10:00 PM", tags: ["步行", "午餐"], shopping_items: [] },
                    { time: "16:00", title: "按摩：Jaens Spa", type: "SPA", price: "IDR 300,000-500,000", address: "Jl. Raya Pengosekan", coords: [-8.517, 115.263], note: "<b>備註：</b>當地評價極高的老牌 SPA，建議選 Balinese Massage。按摩持續60-90分鐘，使用芳香精油；環境私密，音樂輕柔；結束後可喝薑茶恢復。<br><b>開放時間：</b>每天 9:00 AM 至 9:00 PM", tags: ["步行", "按摩"], shopping_items: [] },
                    { time: "18:30", title: "晚餐：Kebun Bistro", type: "餐飲", price: "IDR 200,000", address: "Jl. Hanoman No.44", coords: [-8.5136, 115.26421], note: "<b>特色：</b>南法鄉村風小酒館，紅白酒單豐富，適合單身女性獨酌。酒館有吧台座位，可點小份tapas；氛圍浪漫，建議預約窗邊位；搭配cheese platter享用。<br><b>開放時間：</b>每天 11:00 AM 至 11:00 PM，週五至週日早午餐 9:00 AM 至 3:00 PM", tags: ["步行", "晚餐", "單身女性友善"], shopping_items: [] }
                ]
            },
            "day4": {
                "date": "9/28 (一)",
                "events": [
                    { time: "08:00", title: "沿 Jalan Hanoman 散步至 Ubud Morning Market (晨間市集)", type: "活動", price: "IDR 20,000-50,000", address: "Jl. Raya Ubud, Ubud", coords: [-8.5077, 115.27108], note: "<b>活動：</b>感受當地生活，買一點熱帶水果。市集熱鬧，預留1小時討價還價；攤位有新鮮芒果和香蕉，可試吃；注意人潮，保管隨身物品。<br><b>開放時間：</b>清晨 3:00 AM 至 9:00 AM（本地市場），之後轉為觀光市場至 6:00 PM<br><b>交通方式：</b> 全程步行 (Walking Day)。總步行距離約3-4公里，分散於上午；建議穿運動鞋，並每30分鐘找陰涼處休息；9月早上有涼風，適合晨間活動。", tags: ["步行", "市集"], shopping_items: ["熱帶水果"] },
                    { time: "09:30", title: "香氛站 1：Blue Stone Botanicals", type: "購物", price: "Rp 135,000-165,000", address: "Jl. Dewi Sita", coords: [-8.5193, 115.2653], note: "<b>特色：</b>購買雨林與島嶼靈感的天然精油。店內有試聞區，預留30分鐘挑選；精油可用于家用擴香器；店員可提供配方建議。<br><b>開放時間：</b>通常每天 10:00 AM 至 8:00 PM", tags: ["香氛", "購物"], shopping_items: ["天然精油"] },
                    { time: "10:15", title: "香氛站 2：Bohe Bali Perfumery", type: "購物", price: "USD 7-17", address: "Jl. Monkey Forest", coords: [-8.51242, 115.26098], note: "<b>特色：</b>精緻包裝的香水店，適合挑選禮物。店內陳列多種香調，預留30分鐘測試；有禮盒選項，可加購包裝紙。<br><b>開放時間：</b>每天 10:00 AM 至 9:00 PM", tags: ["香氛", "購物"], shopping_items: ["香水", "禮物"] },
                    { time: "11:00", title: "香氛站 3：OILAND", type: "購物", price: "IDR 100,000-200,000", address: "Jl. Hanoman No.30a", coords: [-8.5196, 115.26324], note: "<b>特色：</b>天然身體護膚油。產品有按摩油和潤膚油，預留20分鐘咨詢；可試用樣本於手背。<br><b>開放時間：</b>每天 10:00 AM 至 8:00 PM", tags: ["香氛", "購物"], shopping_items: ["護膚油"] },
                    { time: "11:30", title: "回到飯店休息，午餐可在附近的 Taco Casa 解決", type: "休息/餐飲", price: "Rp 55,000", address: "Jl. Pengosekan, Ubud", coords: [-8.531, 115.264], note: "休息時間預留1小時，可在房間泡澡；Taco Casa有墨西哥捲餅，快速用餐。<br><b>開放時間：</b>每天 11:00 AM 至 10:00 PM", tags: ["步行", "午餐"], shopping_items: [] },
                    { time: "14:00", title: "按摩：Zen Bali Spa 或 Putri Bali Spa 2", type: "SPA", price: "IDR 130,000-150,000", address: "Jl. Hanoman / Pengosekan", coords: [-8.513, 115.263], note: "<b>備註：</b> (替換原本的 Karsa Spa) 省去舟車勞頓，享受飯店附近的優質按摩。按摩室有私人空間，使用峇里島草藥；可加選熱石療法延長療效。<br><b>開放時間：</b>每天 9:00 AM 至 9:00 PM（兩家相似）", tags: ["步行", "按摩"], shopping_items: [] },
                    { time: "18:30", title: "晚餐：Laminak", type: "餐飲", price: "IDR 200,000-300,000", address: "Jl. Raya Pengosekan", coords: [-8.517, 115.263], note: "<b>特色：</b> (替換原本的 Mozaic) 巴斯克/西班牙料理，氣氛溫馨，就在超市附近。推薦paella或tapas，搭配sangria；餐廳有現場音樂，適合放鬆結束一天。<br><b>開放時間：</b>通常每天 11:00 AM 至 10:00 PM", tags: ["步行", "晚餐"], shopping_items: [] }
                ]
            },
            "day5": {
                "date": "9/29 (二)",
                "events": [
                    { time: "11:00", title: "最後一次超市採買伴手禮 (步行)", type: "購物", price: "", address: "Coco Supermarket", coords: [-8.51798, 115.26357], note: "預留30分鐘，購買巧克力或香氛小物；注意包裝以便攜帶上機。", tags: ["步行", "購物"], shopping_items: ["巧克力", "香氛小物", "伴手禮"] },
                    { time: "12:00", title: "包車司機於飯店大廳接送", type: "交通", price: "", address: "Tegal Sari Accommodation", coords: [-8.5196, 115.26324], note: "出發前，檢查天氣App確認無雨。<br><b>交通方式：</b> 私人包車 (Private Car Charter) - 約 7-8 小時。包車聚焦下午，預估行駛距離約50公里；司機可提供日落時間更新，並準備毯子以防晚間微涼。", tags: ["包車"], shopping_items: [] },
                    { time: "12:30", title: "前往 Svasensa Perfume Workshop", type: "活動", price: "IDR 459,000-600,000", address: "Toya Ubud Eco Park, Jl. Raya Desa Kenderan", coords: [-8.439, 115.281], note: "<b>活動：</b>Advanced / Atelier Session (進階調香，3.5小時)。製作大師級香精。工作坊深入香氛層次，包含調配和瓶裝；可帶回成品作為紀念；過程中可休息喝茶。<br><b>開放時間：</b>需預約，通常每天 9:00 AM 至 6:00 PM", tags: ["調香", "必去"], shopping_items: [] },
                    { time: "16:30", title: "前往 Sayan House", type: "餐飲", price: "RM 193", address: "Jl. Raya Sayan No.70", coords: [-8.50029, 115.23827], note: "<b>開放時間：</b>每天 8:00 AM 至 10:00 PM", tags: ["包車"], shopping_items: [] },
                    { time: "17:30", title: "夕陽晚餐", type: "餐飲", price: "", address: "Sayan House", coords: [-8.50029, 115.23827], note: "<b>活動：</b>在懸崖邊看日落 (9月日落約 18:10)，享用日式拉丁融合料理。餐廳有最佳觀景位，預留2小時觀賞漸變天空；推薦菜餚如壽司捲或ceviche；日落後燈光柔和，安全舒適。", tags: ["晚餐", "日落"], shopping_items: [] },
                    { time: "20:00", title: "司機載回 Tegal Sari", type: "交通", price: "", address: "Tegal Sari Accommodation", coords: [-8.5196, 115.26324], note: "回程約30分鐘，可在車上回顧照片。", tags: ["包車"], shopping_items: [] }
                ]
            },
            "day6": {
                "date": "9/30 (三)",
                "events": [
                    { time: "09:00", title: "在飯店陽台享用早餐，整理行李", type: "休息", price: "", address: "Tegal Sari Accommodation", coords: [-8.5196, 115.26324], note: "早餐選擇新鮮水果和咖啡；整理時檢查房間抽屜避免遺漏。", tags: ["早餐"], shopping_items: [] },
                    { time: "11:00", title: "退房，搭乘酒店專車前往機場", type: "交通", price: "", address: "峇里島伍拉·賴國際機場 (DPS)", coords: [-8.74817, 115.167], note: "退房前，確認帳單並索取發票。<br><b>交通方式：</b> Tegal Sari 酒店專車 (Hotel Transfer)。專車舒適，預估車程2小時；途中可停靠休息站買最後伴手禮。", tags: ["退房", "移動"], shopping_items: [] },
                    { time: "13:30", title: "抵達機場，逛免稅店", type: "購物", price: "", address: "DPS", coords: [-8.74817, 115.167], note: "免稅店有香水和巧克力區，預留2小時購物；注意登機時間。", tags: ["購物"], shopping_items: ["香水", "巧克力"] },
                    { time: "16:10", title: "搭乘 國泰航空 CX784 返港", type: "交通", price: "", address: "DPS", coords: [-8.74817, 115.167], note: "航班提供娛樂系統，可回顧行程照片。", tags: ["移動"], shopping_items: [] }
                ]
            }
        };
        const packingList = ["護照", "機票", "飯店名片", "防蚊噴霧", "防曬霜", "濕紙巾", "舒適防滑鞋", "輕便雨傘", "行動電源", "小風扇"];
        const generalShoppingListItems = ["紅酒", "起司", "水果", "優格", "飲用水", "精油", "香水", "木雕", "銀器", "熱帶水果", "伴手禮"];
        let currentDay = "day1";
        let map = null;
        let markers = [];
        let waterCount = 0;
        // --- Logic ---
        function init() {
            loadCustomData();
            renderDateSelector();
            selectDay('day1', document.querySelector('.date-chip'));
            renderPackingList();
            renderGeneralShoppingList();
            initMap();
            fetchExchangeRate();
        }
        function loadCustomData() {
            const saved = localStorage.getItem('scheduleData');
            if (saved) {
                const customData = JSON.parse(saved);
                Object.keys(customData).forEach(day => {
                    if (!scheduleData[day]) scheduleData[day] = customData[day];
                    else scheduleData[day].events = [...scheduleData[day].events, ... (customData[day].events || [])];
                });
            }
        }
        function saveCustomData() {
            localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
        }
        function switchMainPage(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
           
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(navEl) {
                navEl.classList.add('active');
            } else {
                const idx = ['itinerary', 'map', 'weather', 'shopping'].indexOf(pageId);
                if(idx !== -1) document.querySelectorAll('.nav-item')[idx].classList.add('active');
            }
            if(pageId === 'map' && map) {
                setTimeout(() => { map.invalidateSize(); fitMapToDay(); }, 200);
            }
        }
        function openToolsPage() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-tools').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        }
        function openSubPage(id) { document.getElementById('subpage-' + id).classList.add('open'); }
        function closeSubPage(id) { document.getElementById('subpage-' + id).classList.remove('open'); }
        function renderDateSelector() {
            const container = document.getElementById('date-selector'); container.innerHTML = '';
            Object.keys(scheduleData).forEach(dayKey => {
                const dayInfo = scheduleData[dayKey];
                const dayNum = dayKey.replace('day', '');
                const chip = document.createElement('div');
                chip.className = `date-chip ${dayKey === 'day1' ? 'active' : ''}`;
                chip.onclick = () => selectDay(dayKey, chip);
                chip.innerHTML = `<span class="day-num">D${dayNum}</span><span class="day-week">${dayInfo.date.split(' ')[0]}</span>`;
                container.appendChild(chip);
            });
        }
        function selectDay(dayKey, chipEl) {
            currentDay = dayKey;
            document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
            chipEl.classList.add('active');
           
            renderTimeline(dayKey);
            renderWeather(dayKey);
            renderDailyShopping(dayKey);
            if(map) updateMapMarkers(dayKey);
        }
        function renderTimeline(dayKey) {
            const container = document.getElementById('timeline-container'); container.innerHTML = '';
            const dayTitle = document.createElement('h3'); dayTitle.style.marginBottom='20px';
            dayTitle.innerHTML = `<span style="color:var(--accent-color); font-family:'Playfair Display',serif;">${scheduleData[dayKey].date}</span>`;
            container.appendChild(dayTitle);
            scheduleData[dayKey].events.forEach(event => {
                const item = document.createElement('div'); item.className = 'timeline-item';
                let tagsHtml = event.tags ? event.tags.map(t => {
                    let c = 'card-tag';
                    if(t.includes('必')||t.includes('路痴')||t.includes('重點')) c+=' highlight';
                    if(t.includes('管制')) c+=' alert';
                    return `<span class="${c}">${t}</span>`;
                }).join('') : '';
               
                let priceHtml = event.price ? `<div class="card-price">${event.price}</div>` : '';
                item.innerHTML = `<div class="card" onclick='openEventModal(${JSON.stringify(event)})'>
                    <span class="card-time">${event.time}</span>
                    <h3 class="card-title">${event.title}</h3>
                    <div class="tags">${tagsHtml}</div>
                    ${priceHtml}
                </div>`;
                container.appendChild(item);
            });
        }
        async function renderWeather(dayKey) {
            const container = document.getElementById('weather-content');
            container.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin" style="font-size:2rem; color:white;"></i></div>';
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=-8.5069&longitude=115.2625&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FJakarta');
                const data = await response.json();
                const current = data.current;
                const daily = data.daily;
               
                let icon = "fa-cloud-sun";
                let desc = "多雲";
                if (current.weather_code === 0) { icon = "fa-sun"; desc = "晴朗"; }
                else if (current.weather_code >= 1 && current.weather_code <= 3) { icon = "fa-cloud"; desc = "多雲"; }
                else if (current.weather_code >= 51) { icon = "fa-cloud-rain"; desc = "有雨"; }
               
                const temp = Math.round(current.temperature_2m);
                const humidity = current.relative_humidity_2m;
                const rainChance = daily.precipitation_probability_max[0];
               
                container.innerHTML = `
                    <div class="weather-card">
                        <div style="font-size:0.9rem; opacity:0.9;">${scheduleData[dayKey].date} • 烏布</div>
                        <div class="weather-main">
                            <div class="weather-icon"><i class="fa-solid ${icon}"></i></div>
                            <div class="weather-temp">${temp}°C</div>
                        </div>
                        <div style="font-size:1.2rem; margin-bottom:15px;">${desc}</div>
                        <div class="weather-grid">
                            <div class="w-item"><i class="fa-solid fa-droplet"></i> 濕度 ${humidity}%</div>
                            <div class="w-item"><i class="fa-solid fa-umbrella"></i> 降雨 ${rainChance}%</div>
                            <div class="w-item"><i class="fa-solid fa-wind"></i> 風速 ${current.wind_speed_10m} km/h</div>
                            <div class="w-item"><i class="fa-solid fa-temperature-arrow-up"></i> 體感 ${temp + 2}°</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<p style="text-align:center; color:white;">無法載入天氣數據，請檢查網路。</p>';
            }
        }
       
        function addWater() {
            waterCount++;
            document.getElementById('water-count').innerText = waterCount;
        }
        function renderDailyShopping(dayKey) {
            const container = document.getElementById('daily-shopping-list');
            container.innerHTML = '';
           
            const events = scheduleData[dayKey].events;
            let hasItems = false;
            events.forEach(event => {
                if (event.shopping_items && event.shopping_items.length > 0) {
                    hasItems = true;
                    const group = document.createElement('div');
                    group.className = 'shopping-group';
                   
                    let itemsHtml = '';
                    event.shopping_items.forEach((item, i) => {
                        const id = `shop-${dayKey}-${event.title}-${i}`;
                        const isChecked = localStorage.getItem('check_' + id) === 'true' ? 'checked' : '';
                        const checkedClass = isChecked ? 'checked' : '';
                        itemsHtml += `<div class="checklist-item ${checkedClass}" onclick="toggleCheck(this)">
                            <input type="checkbox" id="${id}" ${isChecked}>
                            <label for="${id}"><span>${item}</span></label>
                        </div>`;
                    });
                    group.innerHTML = `<h4 class="shopping-section-title"><i class="fa-solid fa-location-dot"></i> ${event.title}</h4>${itemsHtml}`;
                    container.appendChild(group);
                }
            });
            if (!hasItems) {
                container.innerHTML = `<div style="text-align:center; padding:30px; opacity:0.5;">
                    <i class="fa-solid fa-bag-shopping" style="font-size:2rem; margin-bottom:10px;"></i><br>
                    本日以觀光為主，無特定購物建議
                </div>`;
            }
        }
        function renderGeneralShoppingList() {
            const container = document.getElementById('general-shopping-container');
            container.innerHTML = '';
            generalShoppingListItems.forEach((item,i) => {
                const id = `gen-shop-${i}`;
                const isChecked = localStorage.getItem('check_' + id) === 'true' ? 'checked' : '';
                const checkedClass = isChecked ? 'checked' : '';
                container.innerHTML += `<div class="checklist-item ${checkedClass}" onclick="toggleCheck(this)">
                    <input type="checkbox" id="${id}" ${isChecked}>
                    <label for="${id}"><span>${item}</span></label>
                </div>`;
            });
        }
        function renderPackingList() {
            const pC = document.getElementById('packing-list-container');
            pC.innerHTML = '';
            packingList.forEach((item,i) => {
                const id = `pack-${i}`;
                const isChecked = localStorage.getItem('check_' + id) === 'true' ? 'checked' : '';
                const checkedClass = isChecked ? 'checked' : '';
                pC.innerHTML += `<div class="checklist-item ${checkedClass}" onclick="toggleCheck(this)">
                    <input type="checkbox" id="${id}" ${isChecked}>
                    <label for="${id}"><span>${item}</span></label>
                </div>`;
            });
        }
        function toggleCheck(el) {
            const i = el.querySelector('input');
            i.checked = !i.checked;
            el.classList.toggle('checked', i.checked);
            // Save state
            localStorage.setItem('check_' + i.id, i.checked);
        }
        async function fetchExchangeRate() {
            const rateInput = document.getElementById('rate-setting');
            try {
                const response = await fetch('https://api.frankfurter.app/latest?amount=1&from=IDR&to=HKD');
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                const rate = data.rates.HKD;
                rateInput.value = rate.toFixed(5);
                rateInput.style.borderColor = "var(--text-on-light)";
            } catch (error) {
                console.warn('Using default rate', error);
                rateInput.style.borderColor = "var(--accent-color)"; // Indicate offline/error
            }
        }
        function calcRate(type) {
            const rate = parseFloat(document.getElementById('rate-setting').value) || 0.052;
            const jpy = document.getElementById('jpy-input');
            const hkd = document.getElementById('hkd-input');
           
            if(type==='jpy') {
                if(jpy.value === '') hkd.value = '';
                else hkd.value = (jpy.value * rate).toFixed(1);
            } else {
                if(hkd.value === '') jpy.value = '';
                else jpy.value = (hkd.value / rate).toFixed(0);
            }
        }
        function sendSafetyMessage() {
            const btn = document.getElementById('safety-btn');
            const originalText = btn.innerHTML;
           
            if (navigator.geolocation) {
                btn.style.opacity = "0.7";
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin" style="font-size:3rem; color:white; margin-bottom:15px;"></i><h3>定位中...</h3>';
               
                navigator.geolocation.getCurrentPosition(function(pos) {
                    btn.style.opacity = "1";
                    btn.innerHTML = originalText;
                    
                    // Standard Google Maps Query URL
                    const mapLink = `https://www.google.com/maps/search/?api=1&query=${pos.coords.latitude},${pos.coords.longitude}`;
                    const msg = `Hello! 我在烏布一切安好，目前位置：${mapLink}`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
                }, function(err) {
                    btn.style.opacity = "1";
                    btn.innerHTML = originalText;
                    alert("無法獲取定位。請檢查瀏覽器權限或開啟 GPS。");
                }, { timeout: 10000 });
            } else {
                alert("瀏覽器不支援定位功能");
            }
        }
        function openEventModal(event) {
            document.getElementById('modal-title').innerText = event.title;
            document.getElementById('modal-type').innerText = event.type;
            document.getElementById('modal-time').innerText = event.time;
            document.getElementById('modal-address').innerText = event.address;
            document.getElementById('modal-note').innerHTML = event.note;
           
            document.getElementById('taxi-address').innerText = event.address;
            document.getElementById('taxi-name').innerText = event.title;
            document.getElementById('taxi-card').style.display = 'none';
            const priceRow = document.getElementById('modal-price-row');
            if (event.price) {
                priceRow.style.display = 'flex';
                document.getElementById('modal-price').innerText = "預算/門票：" + event.price;
            } else {
                priceRow.style.display = 'none';
            }
            const lc = document.getElementById('modal-links'); lc.innerHTML = '';
            if(event.link) lc.innerHTML = `<a href="${event.link}" target="_blank" class="link-btn"><i class="fa-solid fa-link"></i> 預約/詳情</a>`;
           
            let mapUrl = "";
            if(event.coords && event.coords.length === 2) {
                // Standard Google Maps Coordinates URL
                mapUrl = `https://www.google.com/maps/search/?api=1&query=${event.coords[0]},${event.coords[1]}`;
            } else {
                // Standard Google Maps Search URL
                const q = encodeURIComponent(event.address + " " + event.title);
                mapUrl = `https://www.google.com/maps/search/?api=1&query=${q}`;
            }
            document.getElementById('modal-map-btn').onclick = () => window.open(mapUrl, '_blank');
            document.getElementById('detail-modal').classList.add('open');
        }
       
        function toggleTaxiCard() {
            const card = document.getElementById('taxi-card');
            card.style.display = card.style.display === 'none' ? 'block' : 'none';
        }
        function closeModal() { document.getElementById('detail-modal').classList.remove('open'); }
        document.getElementById('detail-modal').addEventListener('click', function(e){if(e.target===this)closeModal()});
        function openTipsModal() { openEventModal({title:"路痴救星",type:"TIPS",time:"隨時",address:"烏布全區",note:"1.注意步行路線選擇燈光充足、人流較多的主路，避免偏僻小巷。<br>2.善用Google Live View AR導航。<br>3.迷路就搭計程車，並事先核對車牌。", tags:[]}); }
        // --- Map Logic ---
        function initMap() {
            map = L.map('map-container');
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap' }).addTo(map);
            updateMapMarkers(currentDay);
        }
        function updateMapMarkers(dayKey) {
            if(!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
           
            const events = scheduleData[dayKey].events;
            const group = new L.featureGroup();
            events.forEach(event => {
                if(event.coords && event.coords.length === 2) {
                    const navUrl = `https://www.google.com/maps/search/?api=1&query=${event.coords[0]},${event.coords[1]}`;
                    const popupContent = `
                        <div style="text-align:center">
                            <b>${event.title}</b><br>${event.time}<br>
                            <a href="${navUrl}" target="_blank" style="display:inline-block; margin-top:5px; color:#E95464; text-decoration:none; font-weight:bold;">
                                <i class="fa-solid fa-location-arrow"></i> 導航
                            </a>
                        </div>
                    `;
                    const m = L.marker(event.coords).addTo(map).bindPopup(popupContent);
                    markers.push(m);
                    group.addLayer(m);
                }
            });
            if(markers.length > 0) {
                map.fitBounds(group.getBounds(), {padding: [50, 50]});
            } else {
                map.setView([-8.5069, 115.2625], 13);
            }
        }
       
        function fitMapToDay() {
            if(map && markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds(), {padding: [50, 50]});
            }
        }
        // --- Edit Form Logic ---
        function openEditForm() {
            document.getElementById('edit-form').classList.add('open');
        }
        function closeEditForm() {
            document.getElementById('edit-form').classList.remove('open');
        }
        async function saveNewEvent() {
            const newEvent = {
                time: document.getElementById('edit-time').value,
                title: document.getElementById('edit-title').value,
                type: document.getElementById('edit-type').value,
                price: document.getElementById('edit-price').value,
                address: document.getElementById('edit-address').value,
                note: document.getElementById('edit-note').value,
                tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()),
                shopping_items: document.getElementById('edit-shopping').value.split(',').map(i => i.trim()),
                link: document.getElementById('edit-link').value
            };
            const coordsStr = document.getElementById('edit-coords').value;
            if (coordsStr) {
                newEvent.coords = coordsStr.split(',').map(c => parseFloat(c.trim()));
            } else if (newEvent.address) {
                // Try to geocode address using Nominatim (OpenStreetMap)
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(newEvent.address + ', Ubud, Bali')}`);
                    const data = await response.json();
                    if (data.length > 0) {
                        newEvent.coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    }
                } catch (error) {
                    console.error('Geocoding failed:', error);
                }
            }
            if (!scheduleData[currentDay]) {
                scheduleData[currentDay] = { date: "[日期範例]", events: [] };
            }
            scheduleData[currentDay].events.push(newEvent);
            saveCustomData();
            renderDateSelector(); // 更新日期選擇器，如果新增日子
            renderTimeline(currentDay);
            renderDailyShopping(currentDay);
            updateMapMarkers(currentDay);
            closeEditForm();
            // Clear form
            document.querySelectorAll('.edit-content input, .edit-content textarea').forEach(el => el.value = '');
        }
        init();
    </script>
</body>
</html>
