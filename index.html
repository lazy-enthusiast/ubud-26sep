<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>çƒå¸ƒé¦™æ°›æ…¢æ´»ä¹‹æ—…</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
/* â›” [ç³»çµ±æ ¸å¿ƒæ¨£å¼ v31.6] */
:root {
    --bg-body: #f2e8d5; --bg-card: #fdfaf3; 
    --text-main: #5c0d09; --text-sub: #177263; 
    --accent: #d44601; --accent-text: #FFFFFF; 
    --border: rgba(82, 192, 167, 0.2); 
    --font-heading: "Playfair Display", serif; --font-body: "Montserrat", sans-serif;
    --shadow: 0 4px 15px rgba(0,0,0,0.05);
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { font-family: var(--font-body); background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: all 0.3s ease; line-height: 1.5; }

/* Header */
header { background-color: var(--bg-body); opacity: 0.98; backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 0 20px; padding-top: var(--safe-top); height: calc(64px + var(--safe-top)); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; position: relative; z-index: 200; }
header h1 { margin: 0; font-size: 1.2rem; font-weight: 700; letter-spacing: 1px; color: var(--accent); font-family: var(--font-heading); text-transform: capitalize; line-height: 1.2; }
#local-clock { font-size: 0.75rem; color: var(--text-sub); font-weight: 600; letter-spacing: 1px; margin-top: 4px; font-variant-numeric: tabular-nums; }

.header-actions { display: flex; align-items: center; gap: 12px; }
.header-btn { font-size: 1.1rem; cursor: pointer; color: var(--text-main); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; background: transparent; transition: background 0.2s; }

/* Date Selector */
.date-selector-container { background: var(--bg-body); opacity: 0.98; padding: 10px 0; border-bottom: 1px solid var(--border); width: 100%; flex-shrink: 0; position: relative; z-index: 90; box-shadow: var(--shadow); }
.date-selector { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; padding: 0 20px; }
.date-chip { flex: 0 0 auto; min-width: 60px; padding: 8px 12px; border-radius: 20px; cursor: pointer; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-card); border: 1px solid var(--border); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
.date-chip.active { background: var(--text-main); color: var(--bg-body); border-color: var(--text-main); transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
.day-num { font-weight: 700; font-size: 1rem; line-height: 1; margin-bottom: 3px; font-family: var(--font-heading); } 
.day-week { font-size: 0.65rem; font-weight: 500; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase;}

/* Main Structure */
main { flex: 1; overflow-y: hidden; position: relative; }
.page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 20px 0 100px 0; display: none; opacity: 0; transition: opacity 0.3s ease; background-color: var(--bg-body); -webkit-overflow-scrolling: touch; }
.page.active { display: block; opacity: 1; z-index: 10; }
.page-header { padding: 0 20px; margin-bottom: 20px; }
.page-title { font-size: 1.8rem; font-weight: 700; margin: 0; letter-spacing: -0.5px; font-family: var(--font-heading); color: var(--accent); }

/* Timeline */
.timeline-container { padding: 5px 20px; max-width: 800px; margin: 0 auto; }
.timeline-item { position: relative; padding-left: 30px; padding-bottom: 25px; border-left: 2px solid rgba(0,0,0,0.05); }
.timeline-item:last-child { border-left: 2px solid transparent; }
.timeline-item::before { content: ''; position: absolute; left: -6px; top: 20px; width: 10px; height: 10px; background: var(--accent); border-radius: 50%; z-index: 2; border: 2px solid var(--bg-body); box-shadow: 0 0 0 2px var(--accent); }
.card { background-color: var(--bg-card); border-radius: 16px; padding: 20px; padding-right: 50px; box-shadow: var(--shadow); cursor: pointer; position: relative; transition: transform 0.2s; border: 1px solid var(--border); min-height: auto; display: flex; flex-direction: column; justify-content: center; border-left: none; }
.card:active { transform: scale(0.98); opacity: 0.9; }

/* âœ¨ Fixed: Nav Button Vertically Centered */
.card-nav-btn { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.03); color: var(--text-main); display: flex; justify-content: center; align-items: center; font-size: 1rem; border: none; }

.card-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 8px 0; line-height: 1.3; font-family: var(--font-heading); color: var(--text-main); letter-spacing: 0.2px; }
.card-time { font-size: 0.8rem; color: var(--accent); font-weight: 700; margin-bottom: 6px; display: block; font-family: var(--font-body); letter-spacing: 0.5px; text-transform: uppercase;}
.card-tag { font-size: 0.65rem; background: rgba(0,0,0,0.05); padding: 4px 10px; border-radius: 12px; color: var(--text-sub); font-weight: 600; border: none; letter-spacing: 0.5px; display: inline-block; margin-right: 5px; }
.card-tag.highlight { background: var(--accent); color: var(--accent-text); }
.card-tag.alert { border: 1px solid var(--accent); color: var(--accent); background: transparent; }

/* Inspiration (Backup Plan) Cards */
.filter-bar-container { padding: 0 20px 15px 20px; position: sticky; top: 0; z-index: 50; background: var(--bg-body); overflow-x: auto; white-space: nowrap; scrollbar-width: none; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
.filter-chip { display: inline-block; padding: 8px 18px; margin-right: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; font-size: 0.8rem; color: var(--text-sub); cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
.filter-chip.active { background: var(--text-main); color: var(--bg-body); border-color: var(--text-main); }
.inspire-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 25px; padding-right: 50px; color: var(--text-main); position: relative; display: flex; flex-direction: column; justify-content: center; margin-bottom: 15px; cursor: pointer; min-height: 100px; box-shadow: var(--shadow); transition: transform 0.2s; }
.inspire-card:active { transform: scale(0.98); opacity: 0.9; }
.inspire-card.hidden { display: none; }
.inspire-badge { background: var(--accent); color: var(--accent-text); padding: 4px 10px; border-radius: 8px; font-size: 0.65rem; font-weight: 700; position: absolute; top: -10px; left: 20px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.inspire-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 6px 0; font-family: var(--font-heading); color: var(--text-main); }
.inspire-note { font-size: 0.9rem; color: var(--text-sub); line-height: 1.6; }
.inspire-nav-btn { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.03); color: var(--text-main); display: flex; justify-content: center; align-items: center; font-size: 0.9rem; }

/* Modal */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: end; backdrop-filter: blur(5px); cursor: pointer; } 
.modal.open { display: flex; }
.modal-content { background: var(--bg-card); color: var(--text-main); width: 100%; max-width: 600px; max-height: 90vh; border-radius: 25px 25px 0 0; padding: 0 0 40px 0; overflow-y: auto; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); cursor: default; display: flex; flex-direction: column; border-top: 1px solid var(--border); box-shadow: 0 -10px 40px rgba(0,0,0,0.1); transition: transform 0.2s ease-out; }
.modal-handle-container { width: 100%; height: 35px; display: flex; justify-content: center; align-items: center; flex-shrink: 0; touch-action: none; cursor: grab; background: var(--bg-card); border-radius: 25px 25px 0 0; border-bottom: 1px solid transparent; }
.modal-handle { width: 50px; height: 5px; background: #DDDDDD; border-radius: 10px; }
.modal-body { padding: 0 30px 30px 30px; }
.modal-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin: 25px 0; }
.modal-label { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1.5px; display: block; margin-bottom: 8px; font-weight: 700; }
.modal-value { font-size: 1rem; font-weight: 500; color: var(--text-main); font-family: var(--font-body); }
.modal-note-box { background: rgba(242, 232, 213, 0.4); padding: 20px; border-radius: 12px; margin: 20px 0; border-left: 4px solid var(--accent); font-size: 0.95rem; line-height: 1.8; color: var(--text-main); white-space: pre-line; }
.btn-action { width: 100%; padding: 18px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 0.9rem; text-align: center; margin-bottom:12px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: center; align-items: center; gap: 10px; transition: all 0.2s; }
.btn-black { background: var(--text-main); color: var(--bg-body); }
.btn-outline { background: transparent; border: 1px solid var(--text-main); color: var(--text-main); }

/* Nav */
nav.bottom-nav { position: fixed; bottom: 0; width: 100%; background-color: var(--bg-body); opacity: 0.98; display: flex; justify-content: space-around; padding: 12px 0 calc(15px + var(--safe-bottom)) 0; border-top: 1px solid var(--border); z-index: 100; backdrop-filter: blur(10px); }
.nav-item { color: var(--text-sub); text-align: center; font-size: 0.65rem; cursor: pointer; width: 25%; transition: all 0.2s; opacity: 0.6; }
.nav-item.active { color: var(--accent); opacity: 1; font-weight: 700; transform: translateY(-2px); }
.nav-item i { display: block; font-size: 1.3rem; margin-bottom: 5px; }

/* Shopping & Weather Styles (Minimal) */
.shopping-list { padding: 0 20px; }
.shop-item { background: var(--bg-card); padding: 18px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border); transition: all 0.2s; }
.shop-item.checked { opacity: 0.5; background: var(--bg-body); }
.shop-item input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--accent); border-radius: 4px; }
.shop-item label { flex: 1; font-size: 1rem; color: var(--text-main); font-weight: 500; }
.weather-main-card { background: linear-gradient(135deg, #a0d0b0 0%, #177263 100%); color: #fff; border-radius: 20px; padding: 25px; margin: 0 20px 25px 20px; text-align: center; box-shadow: 0 10px 30px rgba(23, 114, 99, 0.2); }
.weather-big-temp { font-size: 4rem; font-weight: 300; margin: 15px 0; font-family: var(--font-heading); }
.weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 0 20px 30px 20px; }
.weather-stat-card { background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: center; height: 90px; }
.ws-value { font-size: 1.2rem; font-weight: 400; color: var(--text-main); font-family: var(--font-heading); }

/* Utility */
#toast { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: var(--bg-body); padding: 12px 25px; border-radius: 30px; font-size: 0.9rem; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s; font-weight: 600; } #toast.show { opacity: 1; }
.sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(3px); } .sidebar-overlay.open { opacity: 1; pointer-events: all; }
.sidebar { position: fixed; top: 0; right: 0; width: 85%; max-width: 320px; height: 100%; background: var(--bg-card); color: var(--text-main); z-index: 1001; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); overflow-y: auto; padding: 25px 25px 100px 25px; border-left: 1px solid var(--border); } .sidebar.open { transform: translateX(0); }
.tool-box { background: var(--bg-card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 15px; } .curr-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1.2rem; text-align: center; background: var(--bg-body); font-weight: 600; color: var(--text-main); }
/* âœ¨ Fixed: Hidden by default to prevent "é—œé–‰" ghost text */
.phrase-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 5000; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; } 
.phrase-overlay.active { display: flex; opacity: 1; pointer-events: all; }
.phrase-content { text-align: center; width: 85%; } .phrase-big { font-size: 2.2rem; font-weight: 700; color: var(--accent); line-height: 1.3; margin-bottom: 25px; word-break: break-word; font-family: var(--font-heading); } 
.close-phrase { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); border: 1px solid var(--border); padding: 12px 40px; border-radius: 30px; color: var(--text-main); cursor: pointer; background: var(--bg-card); font-weight: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }

@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
</style>
</head>
<body>

<script>
// ============================================
//   âš™ï¸ 1. [THEME CONFIG]
// ============================================
const THEME_CONFIG = {
    accentColor: "#d44601",       
    accentText: "#FFFFFF",        
    backgroundColor: "#f2e8d5",   
    cardColor: "#fdfaf3",         
    textColor: "#5c0d09",         
    textSubColor: "#177263",      
    borderColor: "rgba(82, 192, 167, 0.2)",       
    googleFontsUrl: "https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap",
    fontHeading: '"Playfair Display", serif', 
    fontBody: '"Montserrat", sans-serif'
};

// ============================================
//   ğŸ—ºï¸ 2. [DATA]
// ============================================
const CONFIG = { startDate: "2026-09-25", duration: 6 };
const DESTINATION = { name: "Hong Kong", lat: -8.5069, lon: 115.2625, timezone: "Asia/Hong_Kong", currency: "idr", currencyLabel: "IDR", baseCurrency: "HKD", appTitle: "çƒå¸ƒé¦™è–°æ…¢æ´»ä¹‹æ—…" };
const TRIP_INFO = { visa: { type: "VoA", number: "Rp 500k", note: "å»ºè­°äº‹å…ˆç”³è«‹ e-VOA" } };

const USER_ITINERARY = {
    "day1": { 
        "events": [
            { time: "15:00", title: "æŠµé”å³‡é‡Œå³¶æ©Ÿå ´ (DPS)", type: "äº¤é€š", price: "-", address: "Ngurah Rai International Airport", coords: [-8.74817, 115.167], note: "å°‹æ‰¾èˆ‰è‘— 'Tegal Sari' ç‰Œå­çš„å¸æ©Ÿã€‚è‹¥å»¶èª¤ï¼Œé€é WhatsApp è¯ç¹«é£¯åº—ã€‚", tags: ["ç§»å‹•"], moodColor: "#d44601" },
            { time: "17:30", title: "å…¥ä½ Tegal Sari", type: "ä½å®¿", price: "Paid", address: "Jl. Hanoman, Padang Tegal, Ubud", coords: [-8.5196, 115.2632], note: "ç¢ºèªæˆ¿é–“ç‚º 'Upper Floor' ä¸”é¢å‘ç¨»ç”°ã€‚æª¢æŸ¥é–€é–èˆ‡ä¿éšªç®±ã€‚", tags: ["å…¥ä½", "å®‰å…¨"], moodColor: "#177263" },
            { time: "18:00", title: "Coco Supermarket æ¡è²·", type: "è³¼ç‰©", price: "Rp 300k", address: "Jl. Raya Pengosekan", coords: [-8.5179, 115.2635], note: "è²·æ°´ã€æ°´æœã€é˜²èšŠæ¶²ã€å„ªæ ¼ã€‚", tags: ["è³¼ç‰©"], shopping_items: ["ç´…é…’", "èµ·å¸", "æ°´æœ", "é£²ç”¨æ°´", "é˜²èšŠå™´éœ§"] },
            { time: "19:00", title: "æ™šé¤ï¼šPison Ubud", type: "é¤é£²", price: "HKD 100", address: "Jl. Hanoman No. 10X", coords: [-8.5178, 115.2637], note: "ç¨»ç”°æ™¯è§€å’–å•¡å»³ï¼Œé€±äº”æ™šæ°£æ°›ä½³ã€‚é©åˆå–®èº«å¥³æ€§ï¼Œç’°å¢ƒå®‰å…¨ã€‚", tags: ["æ™šé¤", "Chill"], moodColor: "#d44601" },
            { time: "20:30", title: "é£¯åº—é™½å°ä¼‘æ¯", type: "ä¼‘æ¯", price: "-", address: "Tegal Sari Accommodation", coords: [-8.5196, 115.2632], note: "æ³¡èŒ¶ï¼Œè½èŸ²é³´ï¼Œäº«å—ç¬¬ä¸€æ™šçš„å¯§éœã€‚", tags: ["ä¼‘æ¯"], moodColor: "#177263" }
        ],
        "inspiration": [
            { title: "æŒ‰æ‘©å‚™æ¡ˆ (In-room)", tag: "TIRED", type: "SPA", price: "Rp 150k+", time: "10:00 - 22:00", address: "Tegal Sari Accommodation", coords: [-8.5196, 115.2632], note: "å¦‚æœæ­æ©Ÿå¤ªç´¯ä¸æƒ³å‡ºé–€ï¼Œç›´æ¥è«‹é£¯åº—å®‰æ’æˆ¿å…§æŒ‰æ‘©ã€‚\næ¨è–¦ Balinese Massage (60mins)ã€‚" },
            { title: "KAFE", tag: "SOLO", type: "Cafe", price: "Rp 100k", time: "07:30 - 23:00", address: "Jl. Hanoman No.44B, Ubud", coords: [-8.516, 115.264], note: "éå¸¸å®‰å…¨çš„ç¤¾äº¤ä¸­å¿ƒï¼Œå……æ»¿æ•¸ä½éŠç‰§è€…ã€‚æœ‰æ©Ÿé£Ÿç‰©å¾ˆæ£’ï¼Œé©åˆä¸€å€‹äººçœ‹æ›¸ã€å¯«æ—¥è¨˜ã€‚" }
        ],
        "shopping": ["é˜²èšŠæ¶²", "å¤§ç“¶æ°´"]
    },
    "day2": {
        "events": [
            { time: "09:30", title: "åŒ…è»Šå‡ºç™¼", type: "äº¤é€š", price: "-", address: "Tegal Sari Lobby", coords: [-8.5196, 115.2632], note: "æ”œå¸¶æ³³è¡£(è‹¥è¦ä¸‹æ°´)ã€æ¯›å·¾ã€æ°´ã€‚", tags: ["åŒ…è»Š"], moodColor: "#d44601" },
            { time: "09:45", title: "BMC Money Changer", type: "æ›åŒ¯", price: "-", address: "Jl. Raya Pengosekan Ubud No.108", coords: [-8.5179, 115.2635], note: "åŒ¯ç‡è¼ƒå¥½ä¸”å®‰å…¨ï¼Œä¿ç•™æ”¶æ“šã€‚", tags: ["å¿…è¾¦"], moodColor: "#177263" },
            { time: "10:30", title: "Gunung Kawi Sebatu", type: "é«”é©—", price: "Rp 50k", address: "Sebatu, Tegallalang", coords: [-8.3844, 115.293], note: "æ°´æ·¨åŒ–å„€å¼ (Melukat)ã€‚éŠå®¢è¼ƒå°‘ï¼Œèƒ½é‡ä¹¾æ·¨æ¸…æ¶¼ã€‚", tags: ["æ·¨åŒ–", "å¿…å»"], moodColor: "#177263" },
            { time: "12:00", title: "åˆé¤ï¼šæ™¯è§€é¤å»³", type: "é¤é£²", price: "-", address: "Kintamani Area", coords: [-8.283, 115.364], note: "è«‹å¸æ©Ÿæ¨è–¦é¢¨æ™¯å¥½ã€ä¹¾æ·¨çš„é¤å»³ (Nasi Goreng / Satay)ã€‚", tags: ["åˆé¤"], moodColor: "#d44601" },
            { time: "13:30", title: "Svasensa Perfume Workshop", type: "æ´»å‹•", price: "Rp 459k", address: "Toya Ubud Eco Park", coords: [-8.439, 115.281], note: "åˆéšèª¿é¦™ (90 mins)ã€‚å­¸ç¿’é¦™æ°›åŸºç¤ï¼Œè£½ä½œå€‹äººæ¨£æœ¬ã€‚", tags: ["èª¿é¦™", "å¿…å»"], moodColor: "#d44601" },
            { time: "16:00", title: "é¢å…·åšç‰©é¤¨", type: "æ–‡åŒ–", price: "Donation", address: "Setia Darma House of Mask", coords: [-8.5342, 115.2792], note: "ç’°å¢ƒæ¥µç‚ºæ¸…å¹½ï¼Œæ•¸åƒä»¶å‚³çµ±æ”¶è—ã€‚", tags: ["åšç‰©é¤¨"], moodColor: "#177263" },
            { time: "17:30", title: "è¿”å›é£¯åº—æ”¾æˆ°åˆ©å“", type: "äº¤é€š", price: "-", address: "Tegal Sari", coords: [-8.5196, 115.2632], note: "ç¨ä½œä¼‘æ¯ã€‚", tags: ["ä¼‘æ¯"], moodColor: "#177263" },
            { time: "18:30", title: "æ™šé¤ï¼šThe Yoga Barn", type: "é¤é£²", price: "Rp 100k", address: "Jl. Hanoman", coords: [-8.5193, 115.2653], note: "Garden Kafe. æœ‰æ©Ÿå¥åº·æ–™ç†ï¼Œç’°å¢ƒæ”¾é¬†ã€‚", tags: ["å¥åº·"], moodColor: "#d44601" }
        ],
        "inspiration": [
            { title: "Ganesha Bookshop", tag: "RAINY", type: "æ–‡åŒ–", price: "-", time: "09:00 - 18:00", address: "Jl. Raya Ubud, Ubud", coords: [-8.506, 115.262], note: "å¦‚æœä¸‹é›¨ï¼Œé€™è£¡æ˜¯èº²é¿çš„å¥½åœ°æ–¹ã€‚å°ˆè³£å°å°¼æ–‡åŒ–æ›¸ç±ï¼Œä¹Ÿæœ‰äºŒæ‰‹æ›¸ï¼Œæ°£æ°›å®‰éœã€‚" },
            { title: "Lazy Cats Cafe", tag: "TIRED", type: "Cafe", price: "Rp 80k", time: "08:00 - 21:00", address: "Jl. Raya Ubud No.11", coords: [-8.504, 115.257], note: "ä¸æƒ³èµ°å‹•æ™‚ï¼Œé€™è£¡æœ‰å¾ˆèˆ’æœçš„å¾©å¤æ²™ç™¼ã€‚ç”±ç´ é£Ÿè—è¡“å®¶ç¶“ç‡Ÿï¼Œé©åˆæ”¾ç©ºã€‚" }
        ],
        "shopping": ["åšç‰©é¤¨å°ç´€å¿µå“"]
    },
    "day3": {
        "events": [
            { time: "09:30", title: "ARMA Museum", type: "è—è¡“", price: "Rp 150k", address: "Jl. Raya Pengosekan", coords: [-8.5229, 115.2632], note: "åœ¨çš‡å®¶èŠ±åœ’èˆ¬çš„åšç‰©é¤¨æ•£æ­¥ï¼Œæ¬£è³å‚³çµ±ç¹ªç•«ã€‚", tags: ["è—è¡“"], moodColor: "#177263" },
            { time: "11:30", title: "Andong å¤è‘£è¡—", type: "è³¼ç‰©", price: "-", address: "Jalan Raya Andong", coords: [-8.5077, 115.2710], note: "æ­è»Šå»ä¸Šæ¸¸ï¼Œæ…¢æ…¢é€›ä¸‹ä¾†ã€‚æœ¨é›•ã€å¾©å¤å°ç‰©ã€‚", tags: ["è³¼ç‰©"], moodColor: "#d44601" },
            { time: "13:30", title: "è¿”å›é£¯åº—é™„è¿‘", type: "äº¤é€š", price: "-", address: "Tegal Sari", coords: [-8.5196, 115.2632], note: "æ”¾ä¸‹æˆ°åˆ©å“ã€‚", tags: ["ä¼‘æ¯"], moodColor: "#177263" },
            { time: "14:00", title: "åˆé¤ï¼šé«’é´¨é£¯ç¸½åº—", type: "é¤é£²", price: "Rp 200k", address: "Bebek Bengil, Jl. Hanoman", coords: [-8.5178, 115.2637], note: "å°±åœ¨é£¯åº—æ—é‚Šã€‚ç¨»ç”°æ¶¼äº­ä½ï¼Œç¶“å…¸å¿…åƒã€‚", tags: ["ç¾é£Ÿ"], moodColor: "#d44601" },
            { time: "16:00", title: "æŒ‰æ‘©ï¼šJaens Spa", type: "SPA", price: "Rp 300k+", address: "Jl. Raya Pengosekan", coords: [-8.517, 115.263], note: "Balinese Massage 90mins. å°±åœ¨é™„è¿‘ï¼Œèµ°è·¯å¯åˆ°ã€‚", tags: ["æ”¾é¬†"], moodColor: "#177263" },
            { time: "18:30", title: "æ™šé¤ï¼šKebun Bistro", type: "é¤é£²", price: "Rp 200k", address: "Jl. Hanoman No.44", coords: [-8.5136, 115.2642], note: "æ³•å¼é„‰æ‘é¢¨ï¼Œç´…ç™½é…’è±å¯Œã€‚é©åˆç¨é…Œã€‚", tags: ["å¾®é†º"], moodColor: "#d44601" }
        ],
        "inspiration": [
            { title: "æ‰¾å€‹ Balian", tag: "SPIRIT", type: "ç„å­¸", price: "éš¨å–œ (ç´„Rp 300k)", time: "éœ€é ç´„", address: "Ubud Area (Ask Driver)", coords: [-8.5069, 115.2625], note: "å¦‚æœå°å‘½ç†æœ‰èˆˆè¶£ï¼Œå¯å˜—è©¦ç•¶åœ°çš„å‚³çµ±æ²»ç™‚å¸« (Balian)ã€‚\nè«‹å¸æ©Ÿæ¨è–¦å¯é çš„å¸«å‚…ï¼Œé€šå¸¸åŒ…å«æ‰‹ç›¸æˆ–èƒ½é‡è§£è®€ã€‚" },
            { title: "Pyramids of Chi", tag: "TIRED", type: "ç™‚ç™’", price: "US$ 25", time: "10:00 / 14:00", address: "Jalan Kelebang Moding, Bentuyung", coords: [-8.486, 115.263], note: "è²é »ç™‚ç™’ (Sound Healing)ã€‚å®Œå…¨èººè‘—ä¸å‹•ï¼Œé€ééŠ…é‘¼è²æ³¢é€²è¡Œæ·±åº¦æ”¾é¬†ï¼Œéå¸¸é©åˆèˆ’ç·©æ—…é€”ç–²å‹ã€‚" }
        ],
        "shopping": ["æœ¨é›•", "éŠ€å™¨"]
    },
    "day4": {
        "events": [
            { time: "08:00", title: "Ubud Morning Market", type: "å¸‚é›†", price: "-", address: "Jl. Raya Ubud", coords: [-8.5065, 115.2625], note: "æ„Ÿå—ç•¶åœ°ç”Ÿæ´»ï¼Œè²·æ–°é®®èŠ’æœã€å±±ç«¹ã€‚", tags: ["æ—©èµ·"], moodColor: "#d44601" },
            { time: "09:30", title: "Blue Stone Botanicals", type: "è³¼ç‰©", price: "-", address: "Jl. Dewi Sita", coords: [-8.5100, 115.2640], note: "å¤©ç„¶ç²¾æ²¹ï¼Œé›¨æ—éˆæ„Ÿã€‚", tags: ["é¦™æ°›"], moodColor: "#177263" },
            { time: "10:15", title: "Bohe Bali Perfumery", type: "è³¼ç‰©", price: "-", address: "Jl. Monkey Forest", coords: [-8.5124, 115.2609], note: "ç²¾ç·»åŒ…è£é¦™æ°´ï¼Œé©åˆé€ç¦®ã€‚", tags: ["é¦™æ°›"], moodColor: "#177263" },
            { time: "11:00", title: "OILAND", type: "è³¼ç‰©", price: "-", address: "Jl. Hanoman No.30a", coords: [-8.5196, 115.2632], note: "å¤©ç„¶èº«é«”è­·è†šæ²¹ã€‚", tags: ["é¦™æ°›"], moodColor: "#177263" },
            { time: "11:30", title: "åˆé¤ï¼šTaco Casa / ä¼‘æ¯", type: "é¤é£²", price: "Rp 60k", address: "Jl. Pengosekan", coords: [-8.531, 115.264], note: "ç°¡å–®åˆé¤ï¼Œå›é£¯åº—ä¼‘æ¯é¿æš‘ã€‚", tags: ["åˆé¤"], moodColor: "#d44601" },
            { time: "14:00", title: "æŒ‰æ‘©ï¼šPutri Bali Spa 2", type: "SPA", price: "Rp 150k", address: "Jl. Hanoman", coords: [-8.513, 115.263], note: "é£¯åº—é™„è¿‘çš„å¹³åƒ¹å„ªè³ªé¸æ“‡ (æ›¿æ› Karsa Spa)ï¼Œçœå»èˆŸè»Šå‹é “ã€‚", tags: ["æ”¾é¬†"], moodColor: "#177263" },
            { time: "18:30", title: "æ™šé¤ï¼šLaminak", type: "é¤é£²", price: "Rp 250k", address: "Jl. Raya Pengosekan", coords: [-8.517, 115.263], note: "å·´æ–¯å…‹/è¥¿ç­ç‰™æ–™ç†ï¼Œæ°£æ°›æº«é¦¨ï¼ŒTapasã€‚", tags: ["æ™šé¤"], moodColor: "#d44601" }
        ],
        "inspiration": [
            { title: "Threads of Life", tag: "PHOTO", type: "æ–‡åŒ–/è³¼ç‰©", price: "-", time: "10:00 - 19:00", address: "Jl. Kajeng No.24", coords: [-8.504, 115.263], note: "ä¸€å®¶åƒåšç‰©é¤¨çš„ç´¡ç¹”å“åº—ã€‚æ”¯æŒåé„‰å©¦å¥³çš„æ‰‹å·¥è—ï¼Œéå¸¸ç²¾ç·»ï¼Œæ‹ç…§å¾ˆç¾ï¼Œä½†å–®åƒ¹è¼ƒé«˜ã€‚" },
            { title: "Room 4 Dessert", tag: "FOOD", type: "ç”œé»", price: "Rp 400k+", time: "16:00 - 22:00", address: "Jl. Raya Sanggingan", coords: [-8.495, 115.253], note: "å¦‚æœæœ‰ç©ºä½ï¼Œå»è©¦è©¦é€™å®¶ä¸Šé Netflix çš„ç”œé» Fine Diningã€‚é©åˆæ…¶ç¥æˆ–çŠ’è³è‡ªå·±ã€‚" }
        ],
        "shopping": ["ç†±å¸¶æ°´æœ", "å¤©ç„¶ç²¾æ²¹", "è­·è†šæ²¹"]
    },
    "day5": {
        "events": [
            { time: "11:00", title: "æœ€å¾Œæ¡è²· (Coco Supermarket)", type: "è³¼ç‰©", price: "-", address: "Coco Supermarket", coords: [-8.5179, 115.2635], note: "è£œé½Šä¼´æ‰‹ç¦®ï¼šå·§å…‹åŠ›ã€é¦™æ°›å°ç‰©ã€‚", tags: ["è³¼ç‰©"], moodColor: "#d44601" },
            { time: "12:00", title: "åŒ…è»Šæ¥é€", type: "äº¤é€š", price: "-", address: "Tegal Sari", coords: [-8.5196, 115.2632], note: "Private Car.", tags: ["åŒ…è»Š"], moodColor: "#d44601" },
            { time: "12:30", title: "Svasensa Atelier", type: "æ´»å‹•", price: "Rp 600k", address: "Toya Ubud Eco Park", coords: [-8.439, 115.281], note: "é€²éšèª¿é¦™ Session (3.5hrs)ã€‚è£½ä½œå¤§å¸«ç´šé¦™ç²¾ã€‚", tags: ["èª¿é¦™", "æ·±åº¦"], moodColor: "#177263" },
            { time: "17:30", title: "Sayan House å¤•é™½æ™šé¤", type: "é¤é£²", price: "Rp 400k", address: "Jl. Raya Sayan No.70", coords: [-8.5002, 115.2382], note: "æ‡¸å´–é‚Šçœ‹æ—¥è½ï¼Œæ—¥å¼æ‹‰ä¸èåˆèœã€‚ä¸€å®šè¦è¨‚ä½ã€‚", tags: ["æ—¥è½", "å¿…å»"], moodColor: "#d44601" },
            { time: "20:00", title: "è¿”å›é£¯åº—", type: "äº¤é€š", price: "-", address: "Tegal Sari", coords: [-8.5196, 115.2632], note: "æ•´ç†è¡Œæã€‚", tags: ["æ•´ç†"], moodColor: "#177263" }
        ],
        "inspiration": [
            { title: "Hujan Locale", tag: "RAINY", type: "é¤é£²", price: "Rp 300k", time: "12:00 - 15:00, 17:30 - 22:00", address: "Jl. Sri Wedari No.5", coords: [-8.505, 115.264], note: "å¦‚æœä¸‹é›¨çœ‹ä¸åˆ°å¤•é™½ï¼Œæ”¹åƒé€™å®¶è‘—åçš„å°å°¼èœ (åº—åæ„æ€å°±æ˜¯'é›¨')ã€‚å‰µæ„ç¾ä»£å°å°¼æ–™ç†ã€‚" },
            { title: "Campuhan Ridge", tag: "PHOTO", type: "å¥è¡Œ", price: "Free", time: "16:00 - 18:00", address: "Campuhan Ridge Walk", coords: [-8.503, 115.255], note: "å¦‚æœèª¿é¦™ææ—©çµæŸï¼Œå¯å»èµ°é€™æ¢è‘—åçš„å±±è„Šæ­¥é“ã€‚è¦–é‡é–‹é—Šï¼Œé©åˆé»ƒæ˜æ•£æ­¥ã€‚" }
        ],
        "shopping": ["å·§å…‹åŠ›", "é¦™æ°›"]
    },
    "day6": {
        "events": [
            { time: "09:00", title: "é£¯åº—æ—©é¤ & æ”¶æ‹¾", type: "ä¼‘æ¯", price: "-", address: "Tegal Sari", coords: [-8.5196, 115.2632], note: "åœ¨é™½å°äº«å—æœ€å¾Œçš„å¯§éœï¼Œæª¢æŸ¥æŠ½å±œã€‚", tags: ["æ•´ç†"], moodColor: "#177263" },
            { time: "11:00", title: "å‰å¾€æ©Ÿå ´ (DPS)", type: "äº¤é€š", price: "-", address: "DPS Airport", coords: [-8.7481, 115.167], note: "CX784 (16:10 èµ·é£›)ã€‚é ç•™ 2 å°æ™‚ä»¥ä¸Šã€‚", tags: ["ç§»å‹•"], moodColor: "#d44601" },
            { time: "13:30", title: "æ©Ÿå ´å…ç¨…åº—", type: "è³¼ç‰©", price: "-", address: "DPS Duty Free", coords: [-8.7481, 115.167], note: "æ¶ˆè€—å‰©ä¸‹çš„å°å°¼ç›¾ã€‚", tags: ["è³¼ç‰©"], moodColor: "#d44601" }
        ],
        "inspiration": [
            { title: "Seniman Coffee", tag: "TIRED", type: "Cafe", price: "Rp 50k", time: "07:30 - 22:00", address: "Jl. Sri Wedari No.5", coords: [-8.505, 115.264], note: "å¦‚æœæ™‚é–“é‚„æ—©ï¼Œå»å–çƒå¸ƒæœ€å¼·å’–å•¡å†èµ°ã€‚è‘—åçš„æ–æ–æ¤…åº§ä½ã€‚" }
        ],
        "shopping": ["å…ç¨…å“"]
    }
};
</script>

<div id="toast"><i class="fa-solid fa-circle-check"></i> <span id="toast-msg">Action Completed</span></div>
<header>
    <div>
        <h1 id="app-title">çƒå¸ƒé¦™æ°›æ…¢æ´»ä¹‹æ—…</h1>
        <div id="local-clock">--:--</div>
    </div>
    <div class="header-actions">
        <div class="header-btn" onclick="openTranslate()"><i class="fa-solid fa-language"></i></div>
        <div class="header-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>
    </div>
</header>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="sidebar">
    <div class="tool-box">
        <div style="font-weight:bold; margin-bottom:15px; color:var(--text-main);">åŒ¯ç‡æ›ç®—</div>
        <div class="currency-grid">
            <div class="curr-group"><span class="curr-label" id="lbl-curr-target">TARGET</span><input type="number" id="curr-jpy" class="curr-input" placeholder="0" oninput="convertCurrency()"></div>
            <div style="text-align:center;"><i class="fa-solid fa-right-left"></i></div>
            <div class="curr-group"><span class="curr-label" id="lbl-curr-base">BASE</span><input type="number" id="curr-hkd" class="curr-input" placeholder="0" readonly></div>
        </div>
    </div>
</div>
<div id="phrase-overlay" class="phrase-overlay" onclick="closePhrase()">
    <div class="phrase-content"><div id="overlay-jp" class="phrase-big"></div><div id="overlay-zh" class="phrase-sub" style="color:var(--text-sub)"></div></div>
    <div class="close-phrase">é—œé–‰</div>
</div>
<div class="date-selector-container"><div class="date-selector" id="date-selector"></div></div>
<main>
    <div id="page-itinerary" class="page active"><div class="timeline-container" id="timeline-container"></div></div>
    <div id="page-inspiration" class="page">
        <div class="filter-bar-container">
            <span class="filter-chip active" onclick="filterInspiration('all', this)">å…¨éƒ¨</span>
            <span class="filter-chip" onclick="filterInspiration('RAINY', this)">â˜” é›¨å¤©</span>
            <span class="filter-chip" onclick="filterInspiration('TIRED', this)">â˜• ä¼‘æ¯</span>
            <span class="filter-chip" onclick="filterInspiration('SPIRIT', this)">âœ¨ ç„å­¸</span>
            <span class="filter-chip" onclick="filterInspiration('PHOTO', this)">ğŸ“· æ‹ç…§</span>
        </div>
        <div id="inspiration-container" class="shopping-list" style="padding:0 20px;"></div>
    </div>
    <div id="page-shopping" class="page"><div class="page-header"><h2 class="page-title">è³¼ç‰©æ¸…å–®</h2></div><div id="shopping-container" class="shopping-list"></div></div>
    <div id="page-weather" class="page">
        <div id="weather-content"><div style="text-align:center; padding:50px;"><i class="fa-solid fa-spinner fa-spin" style="color:var(--accent)"></i></div></div>
        <div id="weather-details-container" style="display:none;">
            <div class="weather-grid">
                <div class="weather-stat-card"><span class="ws-value" id="ws-humidity">--%</span><span class="ws-label">æ¿•åº¦</span></div>
                <div class="weather-stat-card"><span class="ws-value" id="ws-uv">--</span><span class="ws-label">ç´«å¤–ç·š</span></div>
            </div>
            <div style="padding:20px; text-align:center; color:var(--text-sub); font-size:0.8rem;" id="weather-advice-text"></div>
        </div>
    </div>
</main>
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchMainPage('itinerary', this)"><i class="fa-solid fa-calendar-days"></i><span>è¡Œç¨‹</span></div>
    <div class="nav-item" onclick="switchMainPage('inspiration', this)"><i class="fa-solid fa-compass"></i><span>éˆæ„Ÿ</span></div>
    <div class="nav-item" onclick="switchMainPage('shopping', this)"><i class="fa-solid fa-basket-shopping"></i><span>æ¡è²·</span></div>
    <div class="nav-item" onclick="switchMainPage('weather', this)"><i class="fa-solid fa-cloud-sun"></i><span>å¤©æ°£</span></div>
</nav>

<div id="detail-modal" class="modal">
    <div class="modal-content">
        <div class="modal-handle-container" id="modal-drag-area"><div class="modal-handle"></div></div>
        <div id="modal-mini-map" style="height:200px; width:100%; background:#eee;"></div>
        <div class="modal-body">
            <div style="margin-bottom:20px; margin-top:20px;">
                <span class="modal-label" id="modal-type">Type</span>
                <h2 id="modal-title" style="margin:0; font-size:1.6rem; font-family:var(--font-heading); color:var(--accent);">Title</h2>
            </div>
            <div class="modal-info-grid">
                <div><span class="modal-label">æ™‚é–“</span><span class="modal-value" id="modal-time"></span></div>
                <div><span class="modal-label">é ç®—/åƒ¹æ ¼</span><span class="modal-value" id="modal-price"></span></div>
                <div style="grid-column: span 2;"><span class="modal-label">åœ°å€</span><span class="modal-value" id="modal-address-short" style="font-size:0.9rem;"></span></div>
            </div>
            <div class="modal-label">è©³ç´°èªªæ˜</div>
            <div class="modal-note-box"><div id="modal-note" class="modal-note-content"></div></div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- [System Logic] ---
function applyTheme() {
    const root = document.documentElement;
    if(THEME_CONFIG.accentColor) root.style.setProperty('--accent', THEME_CONFIG.accentColor);
    if(THEME_CONFIG.accentText) root.style.setProperty('--accent-text', THEME_CONFIG.accentText);
    if(THEME_CONFIG.backgroundColor) root.style.setProperty('--bg-body', THEME_CONFIG.backgroundColor);
    if(THEME_CONFIG.cardColor) root.style.setProperty('--bg-card', THEME_CONFIG.cardColor);
    if(THEME_CONFIG.textColor) root.style.setProperty('--text-main', THEME_CONFIG.textColor);
    if(THEME_CONFIG.textSubColor) root.style.setProperty('--text-sub', THEME_CONFIG.textSubColor);
    if(THEME_CONFIG.borderColor) root.style.setProperty('--border', THEME_CONFIG.borderColor);
    if(THEME_CONFIG.fontHeading) root.style.setProperty('--font-heading', THEME_CONFIG.fontHeading);
    if(THEME_CONFIG.fontBody) root.style.setProperty('--font-body', THEME_CONFIG.fontBody);
    if(THEME_CONFIG.googleFontsUrl) {
        const link = document.createElement('link'); link.rel = 'stylesheet'; link.href = THEME_CONFIG.googleFontsUrl; document.head.appendChild(link);
    }
}
function generateScheduleData() {
    const dates = {};
    const baseDate = new Date(CONFIG.startDate);
    const duration = CONFIG.duration || 6; 
    const weekDays = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];
    for(let i=0; i<duration; i++) {
        const d = new Date(baseDate); d.setDate(baseDate.getDate() + i);
        const dayKey = `day${i+1}`;
        const yyyy = d.getFullYear(); const mm = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0');
        dates[dayKey] = {
            date: `${yyyy}-${mm}-${dd}`, display: `${mm}/${dd}`, weekday: weekDays[d.getDay()],
            events: (USER_ITINERARY[dayKey] && USER_ITINERARY[dayKey].events) || [],
            inspiration: (USER_ITINERARY[dayKey] && USER_ITINERARY[dayKey].inspiration) || [],
            shopping: (USER_ITINERARY[dayKey] && USER_ITINERARY[dayKey].shopping) || []
        };
    }
    return dates;
}
applyTheme(); 
const scheduleData = generateScheduleData();
let currentDay = "day1";
let modalMap = null;
let currentEventData = null;
let exchangeRate = 0.0005; // IDR to HKD approx
let weatherCache = null;
let shopState = {}; 
// âœ¨ Global Event Store to fix quote issues in onClick
let globalEventStore = {};

function init() { 
    document.getElementById('app-title').innerHTML = DESTINATION.appTitle;
    document.getElementById('lbl-curr-target').innerText = DESTINATION.currencyLabel;
    document.getElementById('lbl-curr-base').innerText = DESTINATION.baseCurrency;

    renderDateSelector(); 
    
    // Auto select today if within range
    const today = new Date().toISOString().split('T')[0];
    let found = false;
    Object.keys(scheduleData).forEach(k => { if(scheduleData[k].date === today) { selectDay(k); found = true; }});
    if(!found) selectDay('day1');

    switchMainPage('itinerary', document.querySelector('.nav-item.active')); 
    if(localStorage.getItem('shopState')) shopState = JSON.parse(localStorage.getItem('shopState'));
    initSwipeClose();
    setInterval(updateLocalClock, 1000); updateLocalClock();
    
    // Default fetch rate
    fetch(`https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${DESTINATION.currency}.json`)
        .then(res => res.json())
        .then(data => { exchangeRate = data[DESTINATION.currency][DESTINATION.baseCurrency.toLowerCase()]; convertCurrency(); })
        .catch(e => console.log('Rate offline'));
}

function updateLocalClock() {
    if(!DESTINATION.timezone) return;
    const options = { timeZone: DESTINATION.timezone, hour: '2-digit', minute: '2-digit', hour12: false };
    const timeString = new Date().toLocaleTimeString('en-HK', options);
    document.getElementById('local-clock').innerText = `${DESTINATION.name} ${timeString}`;
}
function convertCurrency() { const val = parseFloat(document.getElementById('curr-jpy').value); if(!isNaN(val)) { document.getElementById('curr-hkd').value = (val * exchangeRate).toFixed(1); } else { document.getElementById('curr-hkd').value = ""; } }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('open'); }
function openTranslate() { window.open("https://translate.google.com/?sl=auto&tl=zh-TW", "_blank"); }
function switchMainPage(pageId, navEl) { 
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
    document.getElementById('page-' + pageId).classList.add('active'); 
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
    if(navEl) navEl.classList.add('active'); 
    const ds = document.querySelector('.date-selector-container'); 
    ds.style.display = 'block'; 
    if(pageId === 'weather') fetchWeather();
}

async function fetchWeather() {
    const lat = DESTINATION.lat; const lon = DESTINATION.lon; 
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,uv_index_max&current=relative_humidity_2m&timezone=Asia%2FMakassar&forecast_days=1`;
    try {
        const res = await fetch(url); const data = await res.json();
        const d = data.daily;
        const wmo = { 0:'æ™´æœ—', 1:'å¤šé›²', 2:'å¤šé›²', 3:'é™°å¤©', 51:'æ¯›æ¯›é›¨', 61:'é™£é›¨', 80:'é›·é™£é›¨', 95:'é›·é›¨' };
        const w = wmo[d.weathercode[0]] || 'å¤šé›²';
        document.getElementById('weather-content').innerHTML = `<div class="weather-main-card"><div class="weather-big-temp">${Math.round(d.temperature_2m_max[0])}Â°</div><div style="font-weight:500;">${w} â€¢ L:${Math.round(d.temperature_2m_min[0])}Â°</div></div>`;
        document.getElementById('ws-humidity').innerText = data.current.relative_humidity_2m + '%';
        document.getElementById('ws-uv').innerText = d.uv_index_max[0];
        document.getElementById('weather-advice-text').innerText = d.uv_index_max[0] > 7 ? "ç´«å¤–ç·šå¼·ï¼Œè«‹æ³¨æ„é˜²æ›¬ã€‚" : "å¤©æ°£èˆ’é©ã€‚";
        document.getElementById('weather-details-container').style.display = 'block';
    } catch(e) { document.getElementById('weather-content').innerHTML = "<div style='text-align:center; padding:30px;'>æš«æ™‚ç„¡æ³•å–å¾—å¤©æ°£</div>"; }
}

function openMapQuery(address) { const query = encodeURIComponent(address + " Ubud"); window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank'); }
function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => { showToast("å·²è¤‡è£½"); }); }
function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }

// âœ¨ [Fixed OpenModal Logic using Global Store]
function openModalById(eventId) {
    const data = globalEventStore[eventId];
    if(!data) return;
    openModal(data);
}

function openModal(data) { 
    currentEventData = data; 
    document.getElementById('modal-title').innerText = data.title; 
    document.getElementById('modal-type').innerText = data.type || "è¡Œç¨‹"; 
    document.getElementById('modal-time').innerText = data.time || "å½ˆæ€§æ™‚é–“"; 
    document.getElementById('modal-price').innerText = data.price || "æœªå®š"; 
    document.getElementById('modal-address-short').innerText = data.address || DESTINATION.name; 
    document.getElementById('modal-note').innerHTML = data.note || "ç„¡å‚™è¨»"; 
    
    const actionsContainer = document.getElementById('modal-actions'); actionsContainer.innerHTML = ''; 
    const addr = data.address || DESTINATION.name;
    
    actionsContainer.innerHTML += `<button class="btn-action btn-outline" onclick="copyToClipboard('${addr}')"><i class="fa-regular fa-copy"></i> è¤‡è£½åœ°å€</button>`; 
    actionsContainer.innerHTML += `<button class="btn-action btn-black" onclick="openMapQuery('${addr}')"><i class="fa-solid fa-location-arrow"></i> Google Maps</button>`; 
    actionsContainer.innerHTML += `<button class="btn-action btn-outline" onclick="showPhrase('${addr}', 'Pak, tolong ke sini (è«‹è¼‰æˆ‘å»é€™è£¡)')">ğŸš• çµ¦å¸æ©Ÿçœ‹</button>`; 
    
    document.getElementById('detail-modal').classList.add('open'); 
    
    // Reset Map
    setTimeout(() => { 
        if(modalMap) { modalMap.remove(); modalMap = null; }
        const coords = data.coords || [DESTINATION.lat, DESTINATION.lon];
        modalMap = L.map('modal-mini-map', {zoomControl:false, dragging:false, attributionControl: false}).setView(coords, 15); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(modalMap); 
        if(data.coords) L.marker(coords).addTo(modalMap); 
    }, 150); 
}

function closeModal() { document.getElementById('detail-modal').classList.remove('open'); }
document.getElementById('detail-modal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

// âœ¨ [Swipe to Close Logic]
function initSwipeClose() {
    const modalContent = document.querySelector('.modal-content'); const dragArea = document.getElementById('modal-drag-area');
    let startY = 0; let currentY = 0;
    
    dragArea.addEventListener('touchstart', (e) => { 
        startY = e.touches[0].clientY; 
        modalContent.style.transition = 'none'; 
    });
    
    dragArea.addEventListener('touchmove', (e) => { 
        currentY = e.touches[0].clientY; 
        const delta = currentY - startY; 
        if(delta > 0) { // Only allow dragging down
            modalContent.style.transform = `translateY(${delta}px)`; 
        }
    });
    
    dragArea.addEventListener('touchend', () => { 
        const delta = currentY - startY; 
        modalContent.style.transition = 'transform 0.3s ease-out'; 
        if(delta > 100) { // Threshold to close
            closeModal(); 
            setTimeout(() => { modalContent.style.transform = ''; }, 300);
        } else { 
            modalContent.style.transform = ''; 
        }
    });
}

function renderDateSelector() { const container = document.getElementById('date-selector'); container.innerHTML = ''; Object.keys(scheduleData).forEach(dayKey => { const day = scheduleData[dayKey]; const chip = document.createElement('div'); chip.className = `date-chip`; chip.id = `chip-${dayKey}`; chip.onclick = () => selectDay(dayKey, chip); chip.innerHTML = `<span class="day-num">${day.display}</span><span class="day-week">${day.weekday}</span>`; container.appendChild(chip); }); }
function selectDay(dayKey, chipEl) { currentDay = dayKey; document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active')); (chipEl || document.getElementById(`chip-${dayKey}`)).classList.add('active'); if(chipEl) chipEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); renderTimeline(dayKey); renderInspiration(dayKey); renderShopping(dayKey); }

function renderTimeline(dayKey) { 
    const container = document.getElementById('timeline-container'); container.innerHTML = ''; 
    (scheduleData[dayKey].events || []).forEach((event, index) => { 
        const item = document.createElement('div'); item.className = 'timeline-item'; 
        let tags = event.tags.map(t => `<span class="card-tag ${t==='å¿…å»'||t==='å®‰å…¨'?'highlight':''} ${t==='å¿…è¾¦'?'alert':''}">${t}</span>`).join(''); 
        const colorStyle = event.moodColor ? `border-left: 4px solid ${event.moodColor};` : ''; 
        
        // âœ¨ Safe Event Storing
        const eventId = `evt-${dayKey}-${index}`;
        globalEventStore[eventId] = event;

        item.innerHTML = `<div class="card" style="${colorStyle}" onclick="openModalById('${eventId}')"><div class="card-nav-btn" onclick="event.stopPropagation(); openMapQuery('${event.address}')"><i class="fa-solid fa-location-arrow"></i></div><span class="card-time">${event.time}</span><h3 class="card-title">${event.title}</h3><div class="tags">${tags}</div></div>`; 
        container.appendChild(item); 
    }); 
    if(!scheduleData[dayKey].events.length) container.innerHTML = "<div style='text-align:center; padding:50px; color:var(--text-sub);'>æœ¬æ—¥ç„¡è¡Œç¨‹ï¼Œè‡ªç”±æ¢ç´¢ï¼</div>"; 
}

function renderInspiration(dayKey) { 
    const container = document.getElementById('inspiration-container'); container.innerHTML = ''; 
    (scheduleData[dayKey].inspiration || []).forEach((item, index) => { 
        // âœ¨ Safe Event Storing for Inspiration too
        const eventId = `insp-${dayKey}-${index}`;
        globalEventStore[eventId] = item;

        container.innerHTML += `<div class="inspire-card" data-tag="${item.tag}" onclick="openModalById('${eventId}')"><div class="inspire-nav-btn"><i class="fa-solid fa-chevron-right"></i></div><div class="inspire-badge">${item.tag}</div><h3 class="inspire-title">${item.title}</h3><p class="inspire-note">${item.note}</p></div>`; 
    }); 
    if(!scheduleData[dayKey].inspiration.length) container.innerHTML = "<div style='text-align:center; padding:30px; color:var(--text-sub);'>æœ¬æ—¥ç„¡éˆæ„Ÿç­†è¨˜</div>"; 
}

function filterInspiration(tag, btn) { document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('.inspire-card').forEach(card => { if(tag === 'all' || card.getAttribute('data-tag') === tag) card.classList.remove('hidden'); else card.classList.add('hidden'); }); }
function renderShopping(dayKey) { const container = document.getElementById('shopping-container'); container.innerHTML = ''; const items = scheduleData[dayKey].shopping || []; if(items.length === 0) { container.innerHTML = "<div style='color:var(--text-sub); text-align:center; padding:20px;'>ç„¡å¾…è²·æ¸…å–®</div>"; return; } items.forEach((item, idx) => { const uniqueId = `${dayKey}-${idx}`; const isChecked = shopState[uniqueId] ? 'checked' : ''; const div = document.createElement('div'); div.className = `shop-item ${isChecked ? 'checked' : ''}`; div.innerHTML = `<input type="checkbox" id="${uniqueId}" ${isChecked} onchange="toggleShopItem(this, '${uniqueId}')"><label for="${uniqueId}">${item}</label>`; container.appendChild(div); }); }
function toggleShopItem(checkbox, id) { shopState[id] = checkbox.checked; localStorage.setItem('shopState', JSON.stringify(shopState)); checkbox.closest('.shop-item').classList.toggle('checked'); }
function showPhrase(jp, zh) { document.getElementById('overlay-jp').innerText = jp; document.getElementById('overlay-zh').innerText = zh; document.getElementById('phrase-overlay').classList.add('active'); }
function closePhrase() { document.getElementById('phrase-overlay').classList.remove('active'); }

init();
</script>
</body>
</html>
